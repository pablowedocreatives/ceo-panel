<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CEO Command Center</title>
<style>
:root{--bg:#09090b;--bg2:#0f0f12;--card:#18181b;--hover:#1f1f23;--input:#141417;--accent:#8b5cf6;--green:#10b981;--red:#ef4444;--orange:#f59e0b;--blue:#3b82f6;--cyan:#06b6d4;--pink:#ec4899;--yellow:#eab308;--text:#fafafa;--text2:#a1a1aa;--muted:#71717a;--border:#27272a}
*{margin:0;padding:0;box-sizing:border-box}body{font-family:system-ui,sans-serif;background:var(--bg);color:var(--text);min-height:100vh}button{font-family:inherit;cursor:pointer}input,select,textarea{font-family:inherit}
.app{display:flex;min-height:100vh}.sidebar{width:250px;background:var(--bg2);border-right:1px solid var(--border);position:fixed;height:100vh;display:flex;flex-direction:column;z-index:100}.main{margin-left:250px;flex:1}
.sidebar-header{padding:16px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:10px}.logo{width:36px;height:36px;border-radius:8px;background:linear-gradient(135deg,var(--accent),var(--pink));display:flex;align-items:center;justify-content:center;font-weight:800;font-size:14px}.brand{font-weight:700;font-size:16px}.brand span{color:var(--accent);display:block;font-size:10px}
.nav{padding:10px;flex:1;overflow-y:auto}.nav-section{margin-bottom:16px}.nav-label{font-size:9px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:1px;padding:6px 10px}.nav-item{display:flex;align-items:center;gap:8px;padding:8px 10px;border-radius:6px;color:var(--text2);cursor:pointer;font-size:13px}.nav-item:hover{background:var(--card);color:var(--text)}.nav-item.active{background:var(--accent);color:#fff}.nav-badge{margin-left:auto;background:var(--red);color:#fff;font-size:9px;padding:2px 6px;border-radius:6px}
.header{height:56px;background:var(--bg2);border-bottom:1px solid var(--border);display:flex;align-items:center;padding:0 16px;position:sticky;top:0;z-index:100}.page-title{font-size:16px;font-weight:600}
.content{padding:16px}.page{display:none}.page.active{display:block}
.page-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:16px;gap:12px;flex-wrap:wrap}.page-header h1{font-size:22px;font-weight:700}.page-header p{color:var(--text2);font-size:12px}.actions{display:flex;gap:6px}
.btn{display:inline-flex;align-items:center;gap:5px;padding:8px 14px;border-radius:6px;font-size:12px;font-weight:600;border:none}.btn-primary{background:var(--accent);color:#fff}.btn-primary:hover{filter:brightness(1.1)}.btn-danger{background:var(--red);color:#fff}.btn-secondary{background:var(--card);color:var(--text);border:1px solid var(--border)}.btn-secondary:hover{background:var(--hover)}.btn-ghost{background:transparent;color:var(--text2);padding:4px}.btn-ghost:hover{background:var(--card)}.btn-sm{padding:6px 10px;font-size:11px}
.grid{display:grid;gap:12px}.g4{grid-template-columns:repeat(4,1fr)}.g3{grid-template-columns:repeat(3,1fr)}.g2{grid-template-columns:repeat(2,1fr)}
.card{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:14px}.card-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}.card-title{font-size:13px;font-weight:600}.card-link{font-size:11px;color:var(--accent);cursor:pointer}
.stat{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:14px;cursor:pointer;transition:all .2s}.stat:hover{border-color:var(--accent)}.stat-icon{width:40px;height:40px;border-radius:10px;display:flex;align-items:center;justify-content:center;margin-bottom:10px;font-size:18px}.stat-icon.yellow{background:rgba(234,179,8,.12);color:var(--yellow)}.stat-icon.blue{background:rgba(59,130,246,.12);color:var(--blue)}.stat-icon.orange{background:rgba(245,158,11,.12);color:var(--orange)}.stat-icon.green{background:rgba(16,185,129,.12);color:var(--green)}.stat-icon.purple{background:rgba(139,92,246,.12);color:var(--accent)}.stat-icon.cyan{background:rgba(6,182,212,.12);color:var(--cyan)}.stat-value{font-size:24px;font-weight:700}.stat-label{font-size:11px;color:var(--text2)}
.qstats{display:flex;gap:10px;margin-bottom:14px;flex-wrap:wrap}.qstat{background:var(--card);border:1px solid var(--border);border-radius:8px;padding:10px 14px;text-align:center;flex:1;min-width:80px}.qstat-val{font-size:20px;font-weight:700}.qstat-lbl{font-size:9px;color:var(--muted);text-transform:uppercase}
.form-group{margin-bottom:12px}.form-label{display:block;font-size:11px;font-weight:600;color:var(--text2);margin-bottom:4px}.form-input,.form-select,.form-textarea{width:100%;padding:8px 10px;background:var(--input);border:1px solid var(--border);border-radius:6px;color:var(--text);font-size:12px}.form-input:focus,.form-select:focus,.form-textarea:focus{outline:none;border-color:var(--accent)}.form-textarea{min-height:70px;resize:vertical}.form-row{display:flex;gap:10px}.form-row .form-group{flex:1}
.tag{display:inline-flex;padding:3px 8px;border-radius:4px;font-size:10px;font-weight:600}.tag.urgent{background:rgba(239,68,68,.12);color:var(--red)}.tag.high{background:rgba(245,158,11,.12);color:var(--orange)}.tag.medium{background:rgba(59,130,246,.12);color:var(--blue)}.tag.low{background:rgba(16,185,129,.12);color:var(--green)}.tag.idea{background:rgba(234,179,8,.12);color:var(--yellow)}.tag.research{background:rgba(59,130,246,.12);color:var(--blue)}.tag.validated{background:rgba(6,182,212,.12);color:var(--cyan)}.tag.building{background:rgba(139,92,246,.12);color:var(--accent)}.tag.launched{background:rgba(16,185,129,.12);color:var(--green)}.tag.planning{background:rgba(59,130,246,.12);color:var(--blue)}.tag.active{background:rgba(16,185,129,.12);color:var(--green)}.tag.paused{background:rgba(245,158,11,.12);color:var(--orange)}.tag.completed{background:rgba(113,113,122,.12);color:var(--muted)}
.pills{display:flex;gap:5px;margin-bottom:14px;flex-wrap:wrap}.pill{padding:6px 12px;border-radius:16px;font-size:11px;font-weight:500;background:var(--card);color:var(--text2);border:1px solid var(--border);cursor:pointer}.pill:hover{background:var(--hover)}.pill.active{background:var(--accent);color:#fff;border-color:var(--accent)}
.list-item{display:flex;align-items:center;gap:10px;padding:10px;background:var(--input);border-radius:8px;margin-bottom:6px;cursor:pointer}.list-item:hover{background:var(--hover)}.list-item.done{opacity:.5}.item-content{flex:1;min-width:0}.item-title{font-size:12px;font-weight:500;margin-bottom:2px}.item-meta{font-size:10px;color:var(--muted);display:flex;gap:6px;flex-wrap:wrap}.item-actions{display:flex;gap:3px;opacity:0}.list-item:hover .item-actions{opacity:1}
.check{width:18px;height:18px;border:2px solid var(--border);border-radius:4px;display:flex;align-items:center;justify-content:center;font-size:10px;color:transparent;flex-shrink:0}.check:hover{border-color:var(--accent)}.check.checked{background:var(--green);border-color:var(--green);color:#fff}
.avatar{width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:600;flex-shrink:0}.avatar.xl{width:64px;height:64px;font-size:22px;border-radius:12px}.avatar.sm{width:24px;height:24px;font-size:10px}
.empty{text-align:center;padding:30px;color:var(--muted);font-size:12px}
.modal-bg{position:fixed;inset:0;background:rgba(0,0,0,.7);display:none;align-items:center;justify-content:center;z-index:1000;padding:14px}.modal-bg.active{display:flex}.modal{background:var(--card);border:1px solid var(--border);border-radius:12px;width:100%;max-width:480px;max-height:85vh;overflow:hidden;display:flex;flex-direction:column}.modal.lg{max-width:600px}.modal.xl{max-width:800px}.modal-header{display:flex;justify-content:space-between;align-items:center;padding:14px 16px;border-bottom:1px solid var(--border)}.modal-title{font-size:14px;font-weight:600}.modal-close{width:28px;height:28px;border-radius:6px;background:var(--input);border:none;color:var(--text2);cursor:pointer;font-size:14px}.modal-close:hover{background:var(--hover)}.modal-body{padding:16px;overflow-y:auto;flex:1}.modal-footer{display:flex;justify-content:flex-end;gap:8px;padding:12px 16px;border-top:1px solid var(--border);background:var(--bg2)}
.toast-box{position:fixed;bottom:16px;right:16px;z-index:2000}.toast{background:var(--card);border:1px solid var(--border);border-radius:8px;padding:10px 14px;display:flex;align-items:center;gap:8px;font-size:12px;margin-top:8px}.toast.success{border-left:3px solid var(--green)}.toast.error{border-left:3px solid var(--red)}
.funnel{display:flex;gap:10px;overflow-x:auto;padding-bottom:8px}.funnel-col{flex:1;min-width:180px;background:var(--bg2);border-radius:10px;border:1px solid var(--border)}.funnel-header{padding:12px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}.funnel-title{font-size:12px;font-weight:600}.funnel-count{background:var(--input);padding:2px 6px;border-radius:8px;font-size:10px;font-weight:700}.funnel-body{padding:8px;min-height:100px}
.lead-card{background:var(--card);border:1px solid var(--border);border-radius:8px;padding:10px;margin-bottom:6px;cursor:pointer}.lead-card:hover{border-color:var(--accent)}.lead-name{font-size:12px;font-weight:600;margin-bottom:3px}.lead-company{font-size:10px;color:var(--text2);margin-bottom:6px}.lead-footer{display:flex;justify-content:space-between;font-size:10px;color:var(--muted)}.lead-value{font-weight:600;color:var(--green)}
.funnel-add{width:100%;padding:8px;background:transparent;border:1px dashed var(--border);border-radius:6px;color:var(--muted);font-size:11px}.funnel-add:hover{border-color:var(--accent);color:var(--accent)}
.opp-card,.decision-card,.project-card{background:var(--input);border-radius:10px;padding:14px;cursor:pointer;margin-bottom:10px;border-left:3px solid var(--yellow)}.opp-card:hover,.decision-card:hover,.project-card:hover{background:var(--hover)}.opp-card.research{border-left-color:var(--blue)}.opp-card.validated{border-left-color:var(--cyan)}.opp-card.building{border-left-color:var(--accent)}.opp-card.launched{border-left-color:var(--green)}.decision-card{border-left-color:var(--orange)}.decision-card.decided{border-left-color:var(--green);opacity:.7}.project-card{border-left-color:var(--accent)}.project-card.planning{border-left-color:var(--blue)}.project-card.paused{border-left-color:var(--orange)}.project-card.completed{border-left-color:var(--muted)}
.opp-title,.decision-title,.project-title{font-size:14px;font-weight:600;margin-bottom:4px}.opp-desc,.decision-context,.project-desc{font-size:11px;color:var(--text2);margin-bottom:8px}.opp-footer,.decision-footer,.project-footer{display:flex;justify-content:space-between;font-size:10px;color:var(--muted)}
.progress-bar{height:5px;background:var(--bg);border-radius:3px;overflow:hidden;margin-bottom:8px}.progress-fill{height:100%;border-radius:3px}
.member{background:var(--input);border-radius:10px;padding:14px;text-align:center;cursor:pointer}.member:hover{background:var(--hover)}.member .avatar{margin:0 auto 8px}.member-name{font-size:13px;font-weight:600}.member-role{font-size:10px;color:var(--muted)}
.detail-header{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:20px;margin-bottom:16px}.detail-title{font-size:20px;font-weight:700;margin-bottom:4px}.detail-desc{font-size:13px;color:var(--text2);margin-bottom:12px}.detail-meta{display:flex;gap:16px;flex-wrap:wrap;font-size:12px}.detail-meta-item{display:flex;align-items:center;gap:6px}.detail-meta-item span{color:var(--muted)}
.back-btn{display:inline-flex;align-items:center;gap:6px;color:var(--text2);font-size:12px;cursor:pointer;margin-bottom:12px}.back-btn:hover{color:var(--text)}
.mobile-header{display:none;position:fixed;top:0;left:0;right:0;height:56px;background:var(--bg2);border-bottom:1px solid var(--border);z-index:90;padding:0 12px;align-items:center;gap:12px}.mobile-header.visible{display:flex}.menu-btn{width:40px;height:40px;background:var(--card);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:18px;display:flex;align-items:center;justify-content:center}.mobile-title{flex:1;font-weight:600;font-size:15px}.mobile-actions{display:flex;gap:6px}
.overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:95}.overlay.active{display:block}
.sidebar{transition:transform .3s ease}
@media(max-width:900px){.g4{grid-template-columns:repeat(2,1fr)}.g3{grid-template-columns:repeat(2,1fr)}}
@media(max-width:768px){
.sidebar{position:fixed;left:0;top:0;transform:translateX(-100%);z-index:100;width:280px;height:100vh}
.sidebar.open{transform:translateX(0)}
.main{margin-left:0;padding-top:56px}
.header{display:none}
.mobile-header{display:flex}
.g4,.g3{grid-template-columns:repeat(2,1fr)}
.content{padding:12px}
.page-header{flex-direction:column;gap:10px}
.page-header h1{font-size:20px}
.actions{width:100%;justify-content:flex-start}
.qstats{gap:8px}
.qstat{padding:8px 10px;min-width:70px}
.qstat-val{font-size:18px}
.stat{padding:12px}
.stat-value{font-size:20px}
.stat-icon{width:36px;height:36px;font-size:16px}
.detail-header{padding:14px}
.detail-title{font-size:18px}
.detail-meta{gap:10px}
.funnel{flex-direction:column}
.funnel-col{min-width:auto}
.modal{max-width:95%;max-height:90vh;margin:10px}
.modal.lg,.modal.xl{max-width:95%}
.modal-body{padding:14px}
.form-row{flex-direction:column;gap:0}
.btn{padding:10px 16px}
.list-item{padding:12px}
.item-actions{opacity:1}
}
@media(max-width:480px){
.g4,.g3,.g2{grid-template-columns:1fr}
.qstats{flex-wrap:wrap}
.qstat{flex:1 1 45%;min-width:0}
.page-header h1{font-size:18px}
.detail-title{font-size:16px}
.detail-meta{flex-direction:column;gap:8px}
.card{padding:12px}
.back-btn{font-size:11px}
}
.mt-1{margin-top:8px}.mt-2{margin-top:14px}.mb-1{margin-bottom:8px}.mb-2{margin-bottom:14px}.text-muted{color:var(--muted)}.text-success{color:var(--green)}.text-warning{color:var(--orange)}
.dash-selector{position:relative}.dash-btn{display:flex;align-items:center;gap:8px;padding:8px 14px;background:var(--card);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:13px;font-weight:600;cursor:pointer}.dash-btn:hover{background:var(--hover)}.dash-btn svg{width:16px;height:16px}.dash-dropdown{position:absolute;top:100%;left:0;margin-top:6px;background:var(--card);border:1px solid var(--border);border-radius:10px;min-width:220px;padding:6px;display:none;z-index:9999;box-shadow:0 10px 40px rgba(0,0,0,.5)}.dash-dropdown.open{display:block}.dash-option{display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:6px;cursor:pointer;font-size:13px;color:var(--text2)}.dash-option:hover{background:var(--hover);color:var(--text)}.dash-option.active{background:var(--accent);color:#fff}.dash-option span{font-size:16px}
</style>
</head>
<body>
<div id="app"></div>
<script>
const STAGES=[{id:'new',name:'Nuevo',icon:'ğŸ†•',color:'var(--accent)'},{id:'contacted',name:'Contactado',icon:'ğŸ“',color:'var(--blue)'},{id:'proposal',name:'Propuesta',icon:'ğŸ“„',color:'var(--cyan)'},{id:'negotiation',name:'NegociaciÃ³n',icon:'ğŸ¤',color:'var(--orange)'},{id:'won',name:'Cerrado',icon:'ğŸ‰',color:'var(--green)'},{id:'lost',name:'Perdido',icon:'âŒ',color:'var(--red)'}];
const SOURCES=[{id:'web',name:'Web'},{id:'referral',name:'Referido'},{id:'cold',name:'Llamada'},{id:'social',name:'RRSS'},{id:'other',name:'Otro'}];
const OPP_ST=[{id:'idea',name:'Idea',icon:'ğŸ’¡'},{id:'research',name:'Investigando',icon:'ğŸ”'},{id:'validated',name:'Validado',icon:'âœ…'},{id:'building',name:'Desarrollando',icon:'ğŸš€'},{id:'launched',name:'Lanzado',icon:'ğŸ‰'}];
const PROJ_ST=[{id:'planning',name:'Planificando'},{id:'active',name:'Activo'},{id:'paused',name:'Pausado'},{id:'completed',name:'Completado'}];
const TAGS=[{id:'clientes',name:'Clientes',icon:'ğŸ‘¥',color:'var(--blue)'},{id:'equipo',name:'Equipo',icon:'ğŸ§‘â€ğŸ¤â€ğŸ§‘',color:'var(--cyan)'},{id:'mercado',name:'Mercado',icon:'ğŸŒ',color:'var(--green)'},{id:'producto',name:'Producto',icon:'ğŸ“¦',color:'var(--accent)'},{id:'comercial',name:'Comercial',icon:'ğŸ’¼',color:'var(--orange)'},{id:'ops',name:'Operaciones',icon:'âš™ï¸',color:'var(--pink)'},{id:'finanzas',name:'Finanzas',icon:'ğŸ’°',color:'var(--yellow)'},{id:'cx',name:'Experiencia',icon:'â­',color:'var(--cyan)'}];
const CLIENT_ST=[{id:'ok',name:'OK',color:'var(--green)'},{id:'review',name:'Revisar',color:'var(--orange)'},{id:'risk',name:'En riesgo',color:'var(--red)'},{id:'new',name:'Nuevo',color:'var(--blue)'}];
const DASHBOARDS=[
{id:'ceo',name:'CEO Overview',icon:'ğŸ‘‘',desc:'VisiÃ³n global'},
{id:'today',name:'Hoy',icon:'ğŸ“†',desc:'Lo urgente de hoy'},
{id:'comercial',name:'Comercial',icon:'ğŸ’¼',desc:'Pipeline y ventas'},
{id:'clientes',name:'Clientes',icon:'ğŸ‘¥',desc:'Cartera y retenciÃ³n'},
{id:'producto',name:'Producto',icon:'ğŸ¯',desc:'Estrategia y oportunidades'},
{id:'equipo',name:'Equipo',icon:'ğŸ§‘â€ğŸ¤â€ğŸ§‘',desc:'Carga y capacidad'}
];
const OBJ_AREAS=[
{id:'comercial',name:'Comercial',icon:'ğŸ’¼',color:'var(--blue)'},
{id:'producto',name:'Producto',icon:'ğŸ¯',color:'var(--accent)'},
{id:'equipo',name:'Equipo',icon:'ğŸ§‘â€ğŸ¤â€ğŸ§‘',color:'var(--cyan)'},
{id:'financiero',name:'Financiero',icon:'ğŸ’°',color:'var(--green)'},
{id:'operaciones',name:'Operaciones',icon:'âš™ï¸',color:'var(--orange)'}
];
let currentDash='ceo';

const DB={
data:null,
defaults:{
company:{name:'WEDO',logo:'W'},currentUser:'u1',
users:[{id:'u1',name:'Alex',initials:'A',role:'CEO',color:'linear-gradient(135deg,#8b5cf6,#ec4899)'},{id:'u2',name:'Fran',initials:'F',role:'Comercial',color:'linear-gradient(135deg,#3b82f6,#06b6d4)'},{id:'u3',name:'Sara',initials:'S',role:'DiseÃ±o',color:'linear-gradient(135deg,#ec4899,#f59e0b)'},{id:'u4',name:'David',initials:'D',role:'Dev',color:'linear-gradient(135deg,#10b981,#06b6d4)'}],
tasks:[
{id:'t1',title:'Definir pricing aitomeiton',assignee:'u1',priority:'urgent',status:'pending',due:'2024-10-30',oppId:'o1',projectId:null},
{id:'t2',title:'Landing page aitomeiton',assignee:'u4',priority:'high',status:'in-progress',due:'2024-11-05',oppId:'o1',projectId:null},
{id:'t3',title:'Estudiar competencia autoescuelas',assignee:'u1',priority:'medium',status:'pending',due:'2024-11-10',oppId:'o2',projectId:null},
{id:'t4',title:'Llamar leads Amazonia',assignee:'u2',priority:'high',status:'pending',due:'2024-10-28',oppId:null,projectId:null},
{id:'t5',title:'DiseÃ±ar nueva home',assignee:'u3',priority:'high',status:'in-progress',due:'2024-11-20',oppId:null,projectId:'pr2'},
{id:'t6',title:'Maquetar secciones',assignee:'u4',priority:'medium',status:'pending',due:'2024-12-01',oppId:null,projectId:'pr2'}
],
leads:[{id:'l1',name:'Restaurante Marina',company:'Marina SL',stage:'proposal',value:3500,source:'web',referrerId:null,assignee:'u2'},{id:'l2',name:'ClÃ­nica Dental Sol',company:'Dental Sol',stage:'negotiation',value:8000,source:'referral',referrerId:'r1',assignee:'u2'},{id:'l3',name:'Gimnasio PowerFit',company:'PowerFit',stage:'new',value:4500,source:'social',referrerId:null,assignee:'u2'},{id:'l4',name:'Inmobiliaria Costa',company:'Costa Homes',stage:'contacted',value:12000,source:'referral',referrerId:'r2',assignee:'u2'},{id:'l5',name:'Autoescuela Express',company:'Express',stage:'won',value:5000,source:'web',referrerId:null,assignee:'u2'},{id:'l6',name:'FloristerÃ­a JardÃ­n',company:'JardÃ­n',stage:'lost',value:2000,source:'cold',referrerId:null,assignee:'u2'}],
referrers:[{id:'r1',name:'Antonio GarcÃ­a',company:'AsesorÃ­a GarcÃ­a',type:'partner'},{id:'r2',name:'LucÃ­a Moreno',company:'Arco Arquitectos',type:'client'}],
opportunities:[
{id:'o1',title:'Servicio IA para clientes',desc:'ConsultorÃ­a de automatizaciÃ³n con IA. Aitomeiton como producto estrella.',status:'building',potential:50000,effort:'high',lead:'u1'},
{id:'o2',title:'SaaS autoescuelas',desc:'Producto propio para gestiÃ³n de autoescuelas',status:'idea',potential:100000,effort:'high',lead:'u1'},
{id:'o3',title:'ExpansiÃ³n inmobiliario',desc:'EspecializaciÃ³n en webs para inmobiliarias',status:'research',potential:30000,effort:'medium',lead:'u2'},
{id:'o4',title:'Servicio foto/video',desc:'ProducciÃ³n audiovisual para clientes',status:'validated',potential:20000,effort:'low',lead:'u3'}
],
decisions:[{id:'d1',title:'Â¿Contratar developer senior?',context:'Carga alta, David saturado. ~35k/aÃ±o',options:'1) Fijo 2) Freelance 3) Esperar',deadline:'2024-11-15',decided:false,decision:''},{id:'d2',title:'Â¿Subir precios 2025?',context:'No subimos en 2 aÃ±os',options:'1) +15% 2) +10% nuevos 3) Mantener',deadline:'2024-12-01',decided:false,decision:''}],
projects:[
{id:'pr1',title:'Lanzamiento aitomeiton',desc:'Landing, pricing, primeros clientes beta',status:'active',progress:40,lead:'u1',due:'2024-12-15'},
{id:'pr2',title:'Web WEDO 2.0',desc:'RediseÃ±o completo web corporativa',status:'planning',progress:10,lead:'u3',due:'2025-01-30'}
],
inbox:[
{id:'i1',text:'Revisar pricing de TODOCAMA - llevan 2 aÃ±os igual',tags:['clientes','finanzas'],created:'2024-10-28',processed:false},
{id:'i2',text:'Â¿Y si hacemos webinars sobre IA para clientes?',tags:['producto','comercial'],created:'2024-10-27',processed:false},
{id:'i3',text:'Hablar con Sara sobre automatizar proceso de diseÃ±o',tags:['equipo','ops'],created:'2024-10-26',processed:false}
],
clients:[
{id:'c1',name:'Enter Properties',status:'ok',services:['web','seo','paid'],mrr:2500,since:'2023-01',aiNeeds:'Chatbot WhatsApp en desarrollo',notes:'Cliente estrella, muy activo',risk:'low'},
{id:'c2',name:'Aventura Amazonia',status:'review',services:['paid','social'],mrr:1800,since:'2023-06',aiNeeds:'Pendiente propuesta automatizaciÃ³n emails',notes:'Lanzamiento Valencia pronto',risk:'low'},
{id:'c3',name:'TODOCAMA',status:'review',services:['web','seo'],mrr:800,since:'2022-03',aiNeeds:'No explorado aÃºn',notes:'Revisar si necesitan mÃ¡s servicios',risk:'medium'},
{id:'c4',name:'Autoescuelas AVAE',status:'ok',services:['web','paid','social'],mrr:1500,since:'2023-09',aiNeeds:'Interesados en chatbot',notes:'Potencial para SaaS propio',risk:'low'},
{id:'c5',name:'Restaurante Marina',status:'new',services:['social'],mrr:400,since:'2024-10',aiNeeds:'Por evaluar',notes:'Cliente nuevo, en onboarding',risk:'low'}
],
objectives:[
{id:'obj1',title:'Alcanzar 15K MRR',area:'comercial',year:2024,target:15000,current:7000,unit:'â‚¬',keyResults:[
{id:'kr1',title:'Cerrar 5 clientes nuevos',target:5,current:2},
{id:'kr2',title:'Upsell a 3 clientes existentes',target:3,current:1},
{id:'kr3',title:'Reducir churn a <5%',target:5,current:8}
]},
{id:'obj2',title:'Lanzar 2 productos propios',area:'producto',year:2024,target:2,current:0,unit:'productos',keyResults:[
{id:'kr4',title:'Lanzar aitomeiton',target:1,current:0},
{id:'kr5',title:'Validar SaaS autoescuelas',target:1,current:0}
]},
{id:'obj3',title:'Equipo de 6 personas',area:'equipo',year:2024,target:6,current:4,unit:'personas',keyResults:[
{id:'kr6',title:'Contratar developer senior',target:1,current:0},
{id:'kr7',title:'Contratar comercial',target:1,current:0}
]},
{id:'obj4',title:'Implementar IA en todos los clientes',area:'producto',year:2024,target:100,current:40,unit:'%',keyResults:[
{id:'kr8',title:'Auditar necesidades IA',target:5,current:2},
{id:'kr9',title:'Implementar 3 chatbots',target:3,current:1}
]}
],
history:[
{date:'2024-10',metrics:{mrr:7000,clients:5,leads:12,won:2,tasks:45}},
{date:'2024-09',metrics:{mrr:6200,clients:4,leads:10,won:1,tasks:38}},
{date:'2024-08',metrics:{mrr:5800,clients:4,leads:8,won:1,tasks:32}}
]
},
init(){const s=localStorage.getItem('ceo_v9');if(s)try{this.data=JSON.parse(s)}catch(e){this.data=JSON.parse(JSON.stringify(this.defaults))}else this.data=JSON.parse(JSON.stringify(this.defaults));this.save()},
save(){localStorage.setItem('ceo_v9',JSON.stringify(this.data))},
reset(){this.data=JSON.parse(JSON.stringify(this.defaults));this.save()},
get(t,id){return this.data[t]?.find(x=>x.id===id)},
me(){return this.get('users',this.data.currentUser)},
byStage(s){return this.data.leads.filter(l=>l.stage===s)},
byRef(r){return this.data.leads.filter(l=>l.referrerId===r)},
tasksByUser(u){return this.data.tasks.filter(t=>t.assignee===u)},
tasksByOpp(o){return this.data.tasks.filter(t=>t.oppId===o)},
tasksByProj(p){return this.data.tasks.filter(t=>t.projectId===p)},
stats(){const t=this.data.tasks,l=this.data.leads,o=this.data.opportunities,d=this.data.decisions,i=this.data.inbox||[],c=this.data.clients||[];return{tasks:t.filter(x=>x.status!=='done').length,activeLeads:l.filter(x=>!['won','lost'].includes(x.stage)).length,pipeline:l.filter(x=>!['won','lost'].includes(x.stage)).reduce((s,x)=>s+(x.value||0),0),won:l.filter(x=>x.stage==='won').reduce((s,x)=>s+(x.value||0),0),opps:o.filter(x=>!['launched'].includes(x.status)).length,decisions:d.filter(x=>!x.decided).length,projects:this.data.projects.filter(x=>x.status==='active').length,inbox:i.filter(x=>!x.processed).length,clientsReview:c.filter(x=>x.status==='review').length}},
add(t,item){item.id=t[0]+Date.now();this.data[t].unshift(item);this.save();return item},
update(t,id,u){const i=this.data[t].findIndex(x=>x.id===id);if(i>-1){this.data[t][i]={...this.data[t][i],...u};this.save()}},
del(t,id){this.data[t]=this.data[t].filter(x=>x.id!==id);this.save()}
};

const U={
money(n){return new Intl.NumberFormat('es-ES',{style:'currency',currency:'EUR',maximumFractionDigits:0}).format(n||0)},
date(d){if(!d)return'-';return new Date(d).toLocaleDateString('es-ES',{day:'numeric',month:'short'})},
pct(a,b){return b>0?Math.round((a/b)*100):0},
progCol(p){return p>=75?'var(--green)':p>=50?'var(--blue)':p>=25?'var(--orange)':'var(--red)'}
};

let page='dashboard';
let detailView=null; // {type:'opp'|'proj', id:'xxx'}

const UI={
toast(msg,type='success'){const c=document.getElementById('toasts');const t=document.createElement('div');t.className='toast '+type;t.innerHTML='<span>'+(type==='success'?'âœ“':'âœ•')+'</span>'+msg;c.appendChild(t);setTimeout(()=>t.remove(),3e3)},
modal(title,body,footer='',size=''){document.getElementById('modals').innerHTML=`<div class="modal-bg active" onclick="if(event.target===this)UI.closeModal()"><div class="modal ${size}"><div class="modal-header"><span class="modal-title">${title}</span><button class="modal-close" onclick="UI.closeModal()">âœ•</button></div><div class="modal-body">${body}</div>${footer?`<div class="modal-footer">${footer}</div>`:''}</div></div>`},
closeModal(){document.getElementById('modals').innerHTML=''},
confirm(msg,fn){this.modal('Confirmar',`<p style="text-align:center;padding:14px">${msg}</p>`,`<button class="btn btn-secondary" onclick="UI.closeModal()">No</button><button class="btn btn-danger" onclick="(${fn})();UI.closeModal()">SÃ­</button>`)},
badges(){const s=DB.stats();['tasksBadge','leadsBadge','oppBadge','decBadge','inboxBadge','clientsBadge'].forEach(id=>{const el=document.getElementById(id);if(el&&el.style){const v={tasksBadge:s.tasks,leadsBadge:s.activeLeads,oppBadge:s.opps,decBadge:s.decisions,inboxBadge:s.inbox,clientsBadge:s.clientsReview}[id];el.textContent=v;el.style.display=v>0?'inline':'none'}})}
};

function nav(p){page=p;detailView=null;document.querySelectorAll('.nav-item').forEach(i=>i.classList.toggle('active',i.dataset.page===p));const title={dashboard:'Dashboard',inbox:'Inbox',tasks:'Tareas',comercial:'Comercial',referrers:'Referidores',opportunities:'Oportunidades',decisions:'Decisiones',projects:'Proyectos',clients:'Clientes',objectives:'Objetivos',team:'Equipo',sowper:'Sowper',settings:'Config'}[p]||p;document.getElementById('pageTitle').textContent=title;const mt=document.getElementById('mobileTitle');if(mt)mt.textContent=title;render()}

function openDetail(type,id){detailView={type,id};render()}
function closeDetail(){detailView=null;render()}

function render(){
const c=document.getElementById('pageContent');
if(page==='sowper'){
c.innerHTML='<iframe src="sowper.html" style="width:100%;height:calc(100vh - 56px);border:none;"></iframe>';
return;
}
if(detailView){
if(detailView.type==='opp') c.innerHTML=pgOppDetail(detailView.id);
else if(detailView.type==='proj') c.innerHTML=pgProjDetail(detailView.id);
else if(detailView.type==='client') c.innerHTML=pgClientDetail(detailView.id);
else if(detailView.type==='obj') c.innerHTML=pgObjDetail(detailView.id);
}else{
c.innerHTML={dashboard:pgDash,inbox:pgInbox,tasks:pgTasks,comercial:pgCom,referrers:pgRef,opportunities:pgOpp,decisions:pgDec,projects:pgProj,clients:pgClients,objectives:pgObjectives,team:pgTeam,settings:pgSet}[page]?.()??pgDash();
}
UI.badges();
}

const avatar=(u,s='')=>u?`<div class="avatar ${s}" style="background:${u.color}">${u.initials}</div>`:`<div class="avatar ${s}" style="background:var(--muted)">?</div>`;
const tag=(t,txt)=>`<span class="tag ${t}">${txt}</span>`;

function taskItem(t,showContext=true){
const u=DB.get('users',t.assignee);
const done=t.status==='done';
const opp=t.oppId?DB.get('opportunities',t.oppId):null;
const proj=t.projectId?DB.get('projects',t.projectId):null;
return`<div class="list-item ${done?'done':''}"><div class="check ${done?'checked':''}" onclick="event.stopPropagation();toggleTask('${t.id}')">âœ“</div><div class="item-content" onclick="editTask('${t.id}')"><div class="item-title">${t.title}</div><div class="item-meta">${tag(t.priority,t.priority)}${t.due?`<span>ğŸ“…${U.date(t.due)}</span>`:''}${showContext&&opp?`<span>ğŸ’¡${opp.title.substring(0,15)}...</span>`:''}${showContext&&proj?`<span>ğŸ¯${proj.title.substring(0,15)}...</span>`:''}</div></div>${u?avatar(u,'sm'):''}</div>`
}

function leadCard(l){const ref=l.referrerId?DB.get('referrers',l.referrerId):null;return`<div class="lead-card" onclick="editLead('${l.id}')" draggable="true" ondragstart="dragLead(event,'${l.id}')"><div class="lead-name">${l.name}</div><div class="lead-company">${l.company||'-'}</div><div class="lead-footer"><span>${ref?'ğŸ‘¥'+ref.name.split(' ')[0]:''}</span><span class="lead-value">${U.money(l.value)}</span></div></div>`}

function oppCard(o){
const st=OPP_ST.find(x=>x.id===o.status);
const tasks=DB.tasksByOpp(o.id);
const done=tasks.filter(t=>t.status==='done').length;
return`<div class="opp-card ${o.status}" onclick="openDetail('opp','${o.id}')"><div style="display:flex;justify-content:space-between"><div class="opp-title">${o.title}</div>${tag(o.status,st?.name||o.status)}</div><div class="opp-desc">${o.desc}</div><div class="opp-footer"><span>ğŸ’°${U.money(o.potential)}</span><span>ğŸ“‹ ${done}/${tasks.length} tareas</span></div></div>`
}

function decCard(d){return`<div class="decision-card ${d.decided?'decided':''}" onclick="editDec('${d.id}')"><div class="decision-title">${d.decided?'âœ… ':''}${d.title}</div><div class="decision-context">${d.context}</div>${d.decided?`<div style="color:var(--green);font-size:11px">â†’ ${d.decision}</div>`:''}<div class="decision-footer">${d.deadline?`<span>ğŸ“…${U.date(d.deadline)}</span>`:''}</div></div>`}

function projCard(p){
const lead=DB.get('users',p.lead);
const tasks=DB.tasksByProj(p.id);
const done=tasks.filter(t=>t.status==='done').length;
return`<div class="project-card ${p.status}" onclick="openDetail('proj','${p.id}')"><div style="display:flex;justify-content:space-between"><div class="project-title">${p.title}</div>${tag(p.status,p.status)}</div><div class="project-desc">${p.desc}</div><div class="progress-bar"><div class="progress-fill" style="width:${p.progress}%;background:${U.progCol(p.progress)}"></div></div><div class="project-footer"><span>${lead?'ğŸ‘¤'+lead.name:''}</span><span>ğŸ“‹ ${done}/${tasks.length} tareas</span><span>ğŸ“…${U.date(p.due)}</span></div></div>`
}

// ============ DETAIL PAGES ============
function pgOppDetail(id){
const o=DB.get('opportunities',id);
if(!o)return'<div class="empty">No encontrado</div>';
const st=OPP_ST.find(x=>x.id===o.status);
const lead=DB.get('users',o.lead);
const tasks=DB.tasksByOpp(id);
const pending=tasks.filter(t=>t.status==='pending');
const inProgress=tasks.filter(t=>t.status==='in-progress');
const done=tasks.filter(t=>t.status==='done');
const pct=tasks.length?U.pct(done.length,tasks.length):0;

return`<div class="page active">
<div class="back-btn" onclick="closeDetail()">â† Volver a Oportunidades</div>
<div class="detail-header">
<div style="display:flex;justify-content:space-between;align-items:start;flex-wrap:wrap;gap:10px">
<div>
<div class="detail-title">ğŸ’¡ ${o.title}</div>
<div class="detail-desc">${o.desc}</div>
</div>
<div class="actions">
<button class="btn btn-secondary btn-sm" onclick="editOppInfo('${o.id}')">âœï¸ Editar</button>
</div>
</div>
<div class="detail-meta">
<div class="detail-meta-item">${tag(o.status,st?.icon+' '+st?.name)}</div>
<div class="detail-meta-item"><span>ğŸ’°</span>${U.money(o.potential)}</div>
<div class="detail-meta-item"><span>âš¡</span>Esfuerzo: ${o.effort}</div>
${lead?`<div class="detail-meta-item"><span>ğŸ‘¤</span>${lead.name}</div>`:''}
</div>
</div>

<div class="qstats">
<div class="qstat"><div class="qstat-val">${tasks.length}</div><div class="qstat-lbl">Tareas</div></div>
<div class="qstat"><div class="qstat-val">${pending.length}</div><div class="qstat-lbl">Pendientes</div></div>
<div class="qstat"><div class="qstat-val">${inProgress.length}</div><div class="qstat-lbl">En progreso</div></div>
<div class="qstat"><div class="qstat-val text-success">${done.length}</div><div class="qstat-lbl">Hechas</div></div>
<div class="qstat"><div class="qstat-val">${pct}%</div><div class="qstat-lbl">Completado</div></div>
</div>

<div class="card">
<div class="card-header">
<div class="card-title">ğŸ“‹ Tareas de esta oportunidad</div>
<button class="btn btn-primary btn-sm" onclick="showTaskModal(null,'opp','${o.id}')">+ AÃ±adir tarea</button>
</div>
${tasks.length?`
<div class="mb-1" style="font-size:11px;color:var(--muted)">Pendientes (${pending.length})</div>
${pending.map(t=>taskItem(t,false)).join('')}
${inProgress.length?`<div class="mt-1 mb-1" style="font-size:11px;color:var(--muted)">En progreso (${inProgress.length})</div>${inProgress.map(t=>taskItem(t,false)).join('')}`:''}
${done.length?`<div class="mt-1 mb-1" style="font-size:11px;color:var(--muted)">Completadas (${done.length})</div>${done.map(t=>taskItem(t,false)).join('')}`:''}
`:'<div class="empty">No hay tareas. Â¡AÃ±ade la primera!</div>'}
</div>
</div>`
}

function pgProjDetail(id){
const p=DB.get('projects',id);
if(!p)return'<div class="empty">No encontrado</div>';
const st=PROJ_ST.find(x=>x.id===p.status);
const lead=DB.get('users',p.lead);
const tasks=DB.tasksByProj(id);
const pending=tasks.filter(t=>t.status==='pending');
const inProgress=tasks.filter(t=>t.status==='in-progress');
const done=tasks.filter(t=>t.status==='done');
const pct=tasks.length?U.pct(done.length,tasks.length):p.progress;

return`<div class="page active">
<div class="back-btn" onclick="closeDetail()">â† Volver a Proyectos</div>
<div class="detail-header">
<div style="display:flex;justify-content:space-between;align-items:start;flex-wrap:wrap;gap:10px">
<div>
<div class="detail-title">ğŸ¯ ${p.title}</div>
<div class="detail-desc">${p.desc}</div>
</div>
<div class="actions">
<button class="btn btn-secondary btn-sm" onclick="editProjInfo('${p.id}')">âœï¸ Editar</button>
</div>
</div>
<div class="progress-bar mt-1" style="height:8px"><div class="progress-fill" style="width:${pct}%;background:${U.progCol(pct)}"></div></div>
<div class="detail-meta">
<div class="detail-meta-item">${tag(p.status,st?.name||p.status)}</div>
<div class="detail-meta-item"><span>ğŸ“…</span>${U.date(p.due)}</div>
${lead?`<div class="detail-meta-item"><span>ğŸ‘¤</span>${lead.name}</div>`:''}
<div class="detail-meta-item"><span>ğŸ“Š</span>${pct}% completado</div>
</div>
</div>

<div class="qstats">
<div class="qstat"><div class="qstat-val">${tasks.length}</div><div class="qstat-lbl">Tareas</div></div>
<div class="qstat"><div class="qstat-val">${pending.length}</div><div class="qstat-lbl">Pendientes</div></div>
<div class="qstat"><div class="qstat-val">${inProgress.length}</div><div class="qstat-lbl">En progreso</div></div>
<div class="qstat"><div class="qstat-val text-success">${done.length}</div><div class="qstat-lbl">Hechas</div></div>
</div>

<div class="card">
<div class="card-header">
<div class="card-title">ğŸ“‹ Tareas del proyecto</div>
<button class="btn btn-primary btn-sm" onclick="showTaskModal(null,'proj','${p.id}')">+ AÃ±adir tarea</button>
</div>
${tasks.length?`
<div class="mb-1" style="font-size:11px;color:var(--muted)">Pendientes (${pending.length})</div>
${pending.map(t=>taskItem(t,false)).join('')}
${inProgress.length?`<div class="mt-1 mb-1" style="font-size:11px;color:var(--muted)">En progreso (${inProgress.length})</div>${inProgress.map(t=>taskItem(t,false)).join('')}`:''}
${done.length?`<div class="mt-1 mb-1" style="font-size:11px;color:var(--muted)">Completadas (${done.length})</div>${done.map(t=>taskItem(t,false)).join('')}`:''}
`:'<div class="empty">No hay tareas. Â¡AÃ±ade la primera!</div>'}
</div>
</div>`
}

// ============ INBOX ============
function pgInbox(){
const items=DB.data.inbox||[];
const pending=items.filter(i=>!i.processed);
const processed=items.filter(i=>i.processed);
return`<div class="page active">
<div class="page-header"><div><h1>ğŸ“¥ Inbox</h1><p>Captura rÃ¡pida de ideas y pensamientos</p></div>
<div class="actions"><button class="btn btn-primary" onclick="showInboxModal()">+ Capturar idea</button></div></div>
<div class="qstats">
<div class="qstat"><div class="qstat-val">${pending.length}</div><div class="qstat-lbl">Pendientes</div></div>
<div class="qstat"><div class="qstat-val">${processed.length}</div><div class="qstat-lbl">Procesados</div></div>
</div>
<div class="card mb-2">
<div class="card-title mb-1">ğŸ“‹ Por procesar</div>
${pending.length?pending.map(i=>inboxItem(i)).join(''):'<div class="empty">Inbox vacÃ­o - Â¡Captura tu primera idea!</div>'}
</div>
${processed.length?`<div class="card"><div class="card-title mb-1">âœ… Procesados</div>${processed.slice(0,5).map(i=>inboxItem(i)).join('')}</div>`:''}</div>`
}

function inboxItem(i){
const tags=i.tags||[];
return`<div class="list-item" onclick="editInbox('${i.id}')" style="border-left:3px solid ${i.processed?'var(--muted)':'var(--accent)'}">
<div class="item-content">
<div class="item-title">${i.text}</div>
<div class="item-meta">${tags.map(t=>{const tg=TAGS.find(x=>x.id===t);return tg?`<span style="color:${tg.color}">${tg.icon}${tg.name}</span>`:''}).join('')}<span>ğŸ“…${U.date(i.created)}</span></div>
</div>
<div class="item-actions">
${!i.processed?`<button class="btn btn-ghost" onclick="event.stopPropagation();processInbox('${i.id}')" title="Marcar procesado">âœ“</button>`:''}
<button class="btn btn-ghost" onclick="event.stopPropagation();convertInbox('${i.id}')" title="Convertir">â†’</button>
</div>
</div>`
}

// ============ CLIENTES ============
function pgClients(){
const clients=DB.data.clients||[];
const review=clients.filter(c=>c.status==='review');
const ok=clients.filter(c=>c.status==='ok');
const risk=clients.filter(c=>c.status==='risk');
const newC=clients.filter(c=>c.status==='new');
const totalMrr=clients.reduce((s,c)=>s+(c.mrr||0),0);
return`<div class="page active">
<div class="page-header"><div><h1>ğŸ‘¥ Clientes</h1><p>RevisiÃ³n estratÃ©gica</p></div>
<div class="actions"><button class="btn btn-primary" onclick="showClientModal()">+ Cliente</button></div></div>
<div class="qstats">
<div class="qstat"><div class="qstat-val">${clients.length}</div><div class="qstat-lbl">Total</div></div>
<div class="qstat"><div class="qstat-val text-warning">${review.length}</div><div class="qstat-lbl">A revisar</div></div>
<div class="qstat"><div class="qstat-val text-success">${ok.length}</div><div class="qstat-lbl">OK</div></div>
<div class="qstat"><div class="qstat-val text-success">${U.money(totalMrr)}</div><div class="qstat-lbl">MRR</div></div>
</div>
<div class="pills" id="clientFilters">
<button class="pill active" onclick="filterClients('all',this)">Todos (${clients.length})</button>
<button class="pill" onclick="filterClients('review',this)">âš ï¸ Revisar (${review.length})</button>
<button class="pill" onclick="filterClients('ok',this)">âœ… OK (${ok.length})</button>
<button class="pill" onclick="filterClients('new',this)">ğŸ†• Nuevos (${newC.length})</button>
</div>
<div class="grid g2" id="clientsGrid">${clients.map(c=>clientCard(c)).join('')}</div>
</div>`
}

function clientCard(c){
const st=CLIENT_ST.find(x=>x.id===c.status);
const services=(c.services||[]).join(', ');
return`<div class="project-card" onclick="openDetail('client','${c.id}')" style="border-left-color:${st?.color||'var(--muted)'}">
<div style="display:flex;justify-content:space-between;align-items:start">
<div class="project-title">${c.name}</div>
${tag(c.status,st?.name||c.status)}
</div>
<div class="project-desc">${services||'Sin servicios'}</div>
<div class="project-footer">
<span>ğŸ’° ${U.money(c.mrr)}/mes</span>
<span>ğŸ“… Desde ${c.since}</span>
</div>
${c.aiNeeds&&c.aiNeeds!=='No explorado aÃºn'?`<div style="margin-top:8px;padding-top:8px;border-top:1px solid var(--border);font-size:11px"><span style="color:var(--accent)">ğŸ¤– IA:</span> ${c.aiNeeds}</div>`:''}
</div>`
}

function pgClientDetail(id){
const c=DB.data.clients.find(x=>x.id===id);
if(!c)return'<div class="empty">No encontrado</div>';
const st=CLIENT_ST.find(x=>x.id===c.status);
const services=(c.services||[]).join(', ');
return`<div class="page active">
<div class="back-btn" onclick="closeDetail()">â† Volver a Clientes</div>
<div class="detail-header">
<div style="display:flex;justify-content:space-between;align-items:start;flex-wrap:wrap;gap:10px">
<div>
<div class="detail-title">ğŸ‘¥ ${c.name}</div>
<div class="detail-desc">Servicios: ${services||'Ninguno'}</div>
</div>
<div class="actions">
<button class="btn btn-secondary btn-sm" onclick="editClientInfo('${c.id}')">âœï¸ Editar</button>
</div>
</div>
<div class="detail-meta">
<div class="detail-meta-item">${tag(c.status,st?.name||c.status)}</div>
<div class="detail-meta-item"><span>ğŸ’°</span>${U.money(c.mrr)}/mes</div>
<div class="detail-meta-item"><span>ğŸ“…</span>Cliente desde ${c.since}</div>
</div>
</div>
<div class="grid g2">
<div class="card">
<div class="card-title mb-1">ğŸ¤– Necesidades IA</div>
<p style="font-size:13px;color:var(--text2)">${c.aiNeeds||'No evaluado'}</p>
<button class="btn btn-secondary btn-sm mt-1" onclick="editClientAI('${c.id}')">Actualizar</button>
</div>
<div class="card">
<div class="card-title mb-1">ğŸ“ Notas</div>
<p style="font-size:13px;color:var(--text2)">${c.notes||'Sin notas'}</p>
</div>
</div>
<div class="card mt-2">
<div class="card-title mb-1">âš¡ Acciones rÃ¡pidas</div>
<div class="actions" style="flex-wrap:wrap">
<button class="btn btn-secondary btn-sm" onclick="createIdeaForClient('${c.id}')">ğŸ’¡ Crear oportunidad</button>
<button class="btn btn-secondary btn-sm" onclick="createTaskForClient('${c.id}')">âœ… Crear tarea</button>
<button class="btn btn-secondary btn-sm" onclick="markClientStatus('${c.id}','ok')">âœ“ Marcar OK</button>
<button class="btn btn-secondary btn-sm" onclick="markClientStatus('${c.id}','review')">âš ï¸ Marcar revisar</button>
</div>
</div>
</div>`
}

function filterClients(f,btn){
document.querySelectorAll('#clientFilters .pill').forEach(p=>p.classList.remove('active'));
btn.classList.add('active');
let clients=DB.data.clients||[];
if(f!=='all')clients=clients.filter(c=>c.status===f);
document.getElementById('clientsGrid').innerHTML=clients.map(c=>clientCard(c)).join('')||'<div class="empty">No hay clientes</div>';
}

// ============ LIST PAGES ============
function pgDash(){
if(currentDash==='today')return pgDashToday();
if(currentDash==='comercial')return pgDashComercial();
if(currentDash==='clientes')return pgDashClientes();
if(currentDash==='producto')return pgDashProducto();
if(currentDash==='equipo')return pgDashEquipo();
return pgDashCEO();
}

// ============ ALERTAS INTELIGENTES ============
function getAlerts(){
const alerts=[];
const now=new Date();
const today=now.toISOString().split('T')[0];
// Decisiones con deadline pasado
(DB.data.decisions||[]).filter(d=>!d.decided&&d.deadline&&d.deadline<today).forEach(d=>alerts.push({type:'danger',icon:'âš¡',text:'DecisiÃ³n atrasada: '+d.title,action:()=>editDec(d.id)}));
// Tareas urgentes sin asignar
DB.data.tasks.filter(t=>t.status!=='done'&&t.priority==='urgent'&&!t.assignee).forEach(t=>alerts.push({type:'warning',icon:'ğŸ”¥',text:'Tarea urgente sin asignar: '+t.title,action:()=>editTask(t.id)}));
// Tareas atrasadas
DB.data.tasks.filter(t=>t.status!=='done'&&t.due&&t.due<today).forEach(t=>alerts.push({type:'warning',icon:'ğŸ“…',text:'Tarea atrasada: '+t.title,action:()=>editTask(t.id)}));
// Clientes en riesgo con MRR alto
(DB.data.clients||[]).filter(c=>c.status==='risk'&&c.mrr>=1000).forEach(c=>alerts.push({type:'danger',icon:'ğŸš¨',text:'Cliente en riesgo ('+U.money(c.mrr)+'/m): '+c.name,action:()=>openDetail('client',c.id)}));
// Oportunidades estancadas (+30 dÃ­as en idea)
(DB.data.opportunities||[]).filter(o=>o.status==='idea').forEach(o=>alerts.push({type:'info',icon:'ğŸ’¡',text:'Oportunidad en "Idea": '+o.title,action:()=>openDetail('opp',o.id)}));
// Inbox sin procesar (+5 items)
const inboxCount=(DB.data.inbox||[]).filter(i=>!i.processed).length;
if(inboxCount>=5)alerts.push({type:'info',icon:'ğŸ“¥',text:inboxCount+' ideas sin procesar en Inbox',action:()=>nav('inbox')});
return alerts;
}

function alertItem(a){
const colors={danger:'var(--red)',warning:'var(--orange)',info:'var(--blue)'};
return`<div class="list-item" onclick="(${a.action})()" style="border-left:3px solid ${colors[a.type]}"><span style="font-size:16px">${a.icon}</span><div class="item-content"><div class="item-title" style="font-size:12px">${a.text}</div></div><span style="color:var(--muted);font-size:18px">â†’</span></div>`;
}

// ============ VISTA HOY ============
function pgDashToday(){
const alerts=getAlerts();
const today=new Date().toISOString().split('T')[0];
const todayTasks=DB.data.tasks.filter(t=>t.status!=='done'&&t.due===today);
const urgentTasks=DB.data.tasks.filter(t=>t.status!=='done'&&(t.priority==='urgent'||t.priority==='high'));
const pendingDecs=DB.data.decisions.filter(d=>!d.decided);
const inboxPending=(DB.data.inbox||[]).filter(i=>!i.processed).slice(0,3);

return`<div class="page active"><div class="page-header"><div><h1>ğŸ“† Hoy</h1><p>Lo que necesita tu atenciÃ³n ahora</p></div></div>
${alerts.length?`<div class="card mb-2" style="border-left:3px solid var(--red)"><div class="card-title mb-1">ğŸš¨ Alertas (${alerts.length})</div>${alerts.slice(0,5).map(a=>alertItem(a)).join('')}${alerts.length>5?`<div class="text-muted" style="font-size:11px;margin-top:8px">+${alerts.length-5} alertas mÃ¡s</div>`:''}</div>`:''}
<div class="grid g2 mb-2">
<div class="card"><div class="card-title mb-1">ğŸ“… Tareas para hoy (${todayTasks.length})</div>${todayTasks.length?todayTasks.map(t=>taskItem(t)).join(''):'<div class="empty">Nada programado para hoy</div>'}</div>
<div class="card"><div class="card-title mb-1">ğŸ”¥ Urgentes/Altas (${urgentTasks.length})</div>${urgentTasks.slice(0,4).map(t=>taskItem(t)).join('')||'<div class="empty">Sin urgencias ğŸ‘</div>'}</div>
</div>
<div class="grid g2">
<div class="card"><div class="card-title mb-1">âš¡ Decisiones pendientes (${pendingDecs.length})</div>${pendingDecs.slice(0,3).map(d=>decCard(d)).join('')||'<div class="empty">Todo decidido</div>'}</div>
<div class="card"><div class="card-title mb-1">ğŸ“¥ Inbox rÃ¡pido</div>${inboxPending.map(i=>inboxItem(i)).join('')||'<div class="empty">Inbox vacÃ­o</div>'}<button class="btn btn-secondary btn-sm mt-1" onclick="showInboxModal()" style="width:100%">+ Capturar idea</button></div>
</div>
</div>`}

function pgDashCEO(){
const s=DB.stats();const me=DB.me();const myTasks=DB.tasksByUser(me.id).filter(t=>t.status!=='done').slice(0,4);const opps=DB.data.opportunities.filter(o=>!['launched'].includes(o.status)).slice(0,3);const decs=DB.data.decisions.filter(d=>!d.decided).slice(0,3);const inboxPending=(DB.data.inbox||[]).filter(i=>!i.processed).slice(0,3);const clientsReview=(DB.data.clients||[]).filter(c=>c.status==='review').slice(0,3);
const alerts=getAlerts();
const objs=DB.data.objectives||[];
const avgObjProgress=objs.length?Math.round(objs.reduce((s,o)=>s+U.pct(o.current,o.target),0)/objs.length):0;
const clients=DB.data.clients||[];
const totalMrr=clients.reduce((s,c)=>s+(c.mrr||0),0);
const history=DB.data.history||[];
const lastMonth=history[1]?.metrics||{};
const mrrChange=lastMonth.mrr?Math.round(((totalMrr-lastMonth.mrr)/lastMonth.mrr)*100):0;
// Sowper stats
const sowperData=JSON.parse(localStorage.getItem('sowper_v3')||'{}');
const sowperAccounts=(sowperData.accounts||[]).filter(a=>a.status==='active'||a.status==='onboarding');
const sowperMRR=sowperAccounts.reduce((t,a)=>t+(a.fee||350),0);
const sowperExpenses=(sowperData.expenses||[]).reduce((t,e)=>t+(e.amount||0),0);
const sowperMargin=sowperMRR-sowperExpenses;

return`<div class="page active"><div class="page-header"><div><h1>ğŸ‘‘ CEO Overview</h1><p>Centro de mando WEDO</p></div><div class="actions"><button class="btn btn-secondary" onclick="showInboxModal()">ğŸ“¥ Capturar</button><button class="btn btn-primary" onclick="showTaskModal()">+ Tarea</button></div></div>
${alerts.length?`<div class="card mb-2" style="border-left:3px solid var(--orange)"><div class="card-header"><div class="card-title">ğŸš¨ Alertas (${alerts.length})</div><span class="card-link" onclick="selectDash('today')">Ver todo â†’</span></div>${alerts.slice(0,3).map(a=>alertItem(a)).join('')}</div>`:''}
<div class="grid g4 mb-2">
<div class="stat" onclick="nav('clients')"><div class="stat-icon green">ğŸ’°</div><div class="stat-value">${U.money(totalMrr)}</div><div class="stat-label">MRR WEDO</div></div>
<div class="stat" onclick="nav('objectives')"><div class="stat-icon purple">ğŸ“ˆ</div><div class="stat-value">${avgObjProgress}%</div><div class="stat-label">Objetivos</div></div>
<div class="stat" onclick="nav('decisions')"><div class="stat-icon orange">âš¡</div><div class="stat-value">${s.decisions}</div><div class="stat-label">Decisiones</div></div>
<div class="stat" onclick="nav('inbox')"><div class="stat-icon cyan">ğŸ“¥</div><div class="stat-value">${s.inbox}</div><div class="stat-label">Inbox</div></div>
</div>
<div class="card mb-2" style="border-left:3px solid var(--green);cursor:pointer" onclick="nav('sowper')">
<div class="card-header"><div class="card-title">ğŸŸ¢ Sowper - Paid Media</div><span class="card-link">Abrir â†’</span></div>
<div class="grid g4">
<div class="qstat"><div class="qstat-val">${sowperAccounts.length}</div><div class="qstat-lbl">Cuentas</div></div>
<div class="qstat"><div class="qstat-val" style="color:var(--green)">${U.money(sowperMRR)}</div><div class="qstat-lbl">MRR</div></div>
<div class="qstat"><div class="qstat-val" style="color:var(--orange)">${U.money(sowperExpenses)}</div><div class="qstat-lbl">Gastos</div></div>
<div class="qstat"><div class="qstat-val" style="color:${sowperMargin>=0?'var(--green)':'var(--red)'}">${U.money(sowperMargin)}</div><div class="qstat-lbl">Margen</div></div>
</div>
</div>
<div class="grid g2">
<div class="card"><div class="card-header"><div class="card-title">ğŸ“ˆ Objetivos del aÃ±o</div><span class="card-link" onclick="nav('objectives')">Ver â†’</span></div>${objs.slice(0,3).map(o=>{const pct=U.pct(o.current,o.target);return`<div style="margin-bottom:10px"><div style="display:flex;justify-content:space-between;font-size:12px;margin-bottom:4px"><span>${o.title}</span><span style="color:${U.progCol(pct)}">${pct}%</span></div><div class="progress-bar" style="height:6px"><div class="progress-fill" style="width:${pct}%;background:${U.progCol(pct)}"></div></div></div>`}).join('')||'<div class="empty">Sin objetivos</div>'}</div>
<div class="card"><div class="card-header"><div class="card-title">ğŸ‘¥ Clientes a revisar</div><span class="card-link" onclick="nav('clients')">Ver â†’</span></div>${clientsReview.length?clientsReview.map(c=>clientCard(c)).join(''):'<div class="empty">Todos OK ğŸ‘</div>'}</div>
</div>
<div class="grid g2 mt-2"><div class="card"><div class="card-header"><div class="card-title">ğŸ’¡ Oportunidades</div><span class="card-link" onclick="nav('opportunities')">Ver â†’</span></div>${opps.length?opps.map(oppCard).join(''):'<div class="empty">Sin oportunidades</div>'}</div><div class="card"><div class="card-header"><div class="card-title">âš¡ Decisiones</div><span class="card-link" onclick="nav('decisions')">Ver â†’</span></div>${decs.length?decs.map(decCard).join(''):'<div class="empty">Todo decidido ğŸ‘</div>'}</div></div>
<div class="grid g2 mt-2"><div class="card"><div class="card-header"><div class="card-title">ğŸ¯ Proyectos activos</div><span class="card-link" onclick="nav('projects')">Ver â†’</span></div>${DB.data.projects.filter(p=>p.status==='active').slice(0,2).map(projCard).join('')||'<div class="empty">-</div>'}</div><div class="card"><div class="card-header"><div class="card-title">âœ… Mis tareas</div><span class="card-link" onclick="nav('tasks')">Ver â†’</span></div>${myTasks.length?myTasks.map(t=>taskItem(t)).join(''):'<div class="empty">Sin tareas ğŸ‰</div>'}</div></div></div>`}

function pgDashComercial(){
const s=DB.stats();const leads=DB.data.leads;const activeLeads=leads.filter(l=>!['won','lost'].includes(l.stage));const wonLeads=leads.filter(l=>l.stage==='won');const lostLeads=leads.filter(l=>l.stage==='lost');const convRate=wonLeads.length+lostLeads.length>0?U.pct(wonLeads.length,wonLeads.length+lostLeads.length):0;const avgDealValue=wonLeads.length>0?Math.round(wonLeads.reduce((s,l)=>s+(l.value||0),0)/wonLeads.length):0;const refs=DB.data.referrers||[];
return`<div class="page active"><div class="page-header"><div><h1>ğŸ’¼ Dashboard Comercial</h1><p>Pipeline y rendimiento de ventas</p></div><div class="actions"><button class="btn btn-primary" onclick="showLeadModal()">+ Nuevo lead</button></div></div>
<div class="grid g4 mb-2">
<div class="stat" onclick="nav('comercial')"><div class="stat-icon blue">ğŸ¯</div><div class="stat-value">${activeLeads.length}</div><div class="stat-label">Leads activos</div></div>
<div class="stat" onclick="nav('comercial')"><div class="stat-icon green">ğŸ’°</div><div class="stat-value">${U.money(s.pipeline)}</div><div class="stat-label">Pipeline</div></div>
<div class="stat"><div class="stat-icon cyan">ğŸ“Š</div><div class="stat-value">${convRate}%</div><div class="stat-label">ConversiÃ³n</div></div>
<div class="stat"><div class="stat-icon yellow">ğŸ’µ</div><div class="stat-value">${U.money(avgDealValue)}</div><div class="stat-label">Ticket medio</div></div>
</div>
<div class="grid g2 mb-2">
<div class="card"><div class="card-title mb-1">ğŸ“Š Embudo</div>
${STAGES.filter(st=>!['won','lost'].includes(st.id)).map(st=>{const count=DB.byStage(st.id).length;const total=activeLeads.length||1;const pct=Math.round((count/total)*100);return`<div style="display:flex;align-items:center;gap:10px;margin-bottom:8px"><span style="font-size:12px;min-width:90px">${st.icon} ${st.name}</span><div style="flex:1;height:8px;background:var(--bg);border-radius:4px"><div style="height:100%;width:${pct}%;background:${st.color};border-radius:4px"></div></div><span style="font-size:12px;font-weight:600">${count}</span></div>`}).join('')}
</div>
<div class="card"><div class="card-title mb-1">ğŸ† Resultados</div>
<div class="qstats" style="margin-bottom:0"><div class="qstat"><div class="qstat-val text-success">${wonLeads.length}</div><div class="qstat-lbl">Ganados</div></div><div class="qstat"><div class="qstat-val" style="color:var(--red)">${lostLeads.length}</div><div class="qstat-lbl">Perdidos</div></div><div class="qstat"><div class="qstat-val text-success">${U.money(s.won)}</div><div class="qstat-lbl">Facturado</div></div></div>
</div></div>
<div class="grid g2">
<div class="card"><div class="card-header"><div class="card-title">ğŸ†• Leads recientes</div><span class="card-link" onclick="nav('comercial')">Ver pipeline â†’</span></div>${activeLeads.slice(0,4).map(l=>leadCard(l)).join('')||'<div class="empty">Sin leads</div>'}</div>
<div class="card"><div class="card-header"><div class="card-title">ğŸ‘¥ Top referidores</div><span class="card-link" onclick="nav('referrers')">Ver todos â†’</span></div>${refs.slice(0,3).map((r,i)=>{const v=DB.byRef(r.id).filter(l=>l.stage==='won').reduce((s,l)=>s+(l.value||0),0);return`<div class="list-item" onclick="nav('referrers')"><span style="font-size:14px">${['ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰'][i]}</span><div class="item-content"><div class="item-title">${r.name}</div><div class="item-meta"><span>${DB.byRef(r.id).length} leads</span></div></div><span style="color:var(--green);font-weight:600">${U.money(v)}</span></div>`}).join('')||'<div class="empty">Sin referidores</div>'}</div>
</div></div>`}

function pgDashClientes(){
const clients=DB.data.clients||[];const totalMrr=clients.reduce((s,c)=>s+(c.mrr||0),0);const review=clients.filter(c=>c.status==='review');const risk=clients.filter(c=>c.status==='risk');const ok=clients.filter(c=>c.status==='ok');const noAI=clients.filter(c=>!c.aiNeeds||c.aiNeeds==='No explorado aÃºn'||c.aiNeeds==='Por evaluar');
return`<div class="page active"><div class="page-header"><div><h1>ğŸ‘¥ Dashboard Clientes</h1><p>Cartera y retenciÃ³n</p></div><div class="actions"><button class="btn btn-primary" onclick="showClientModal()">+ Cliente</button></div></div>
<div class="grid g4 mb-2">
<div class="stat" onclick="nav('clients')"><div class="stat-icon blue">ğŸ‘¥</div><div class="stat-value">${clients.length}</div><div class="stat-label">Clientes</div></div>
<div class="stat"><div class="stat-icon green">ğŸ’°</div><div class="stat-value">${U.money(totalMrr)}</div><div class="stat-label">MRR Total</div></div>
<div class="stat"><div class="stat-icon orange">âš ï¸</div><div class="stat-value">${review.length+risk.length}</div><div class="stat-label">AtenciÃ³n</div></div>
<div class="stat"><div class="stat-icon cyan">ğŸ¤–</div><div class="stat-value">${noAI.length}</div><div class="stat-label">Sin evaluar IA</div></div>
</div>
<div class="grid g2 mb-2">
<div class="card"><div class="card-title mb-1">ğŸ“Š Estado cartera</div>
<div style="display:flex;align-items:center;gap:10px;margin-bottom:8px"><span style="font-size:12px;min-width:70px">âœ… OK</span><div style="flex:1;height:8px;background:var(--bg);border-radius:4px"><div style="height:100%;width:${U.pct(ok.length,clients.length)}%;background:var(--green);border-radius:4px"></div></div><span style="font-size:12px;font-weight:600">${ok.length}</span></div>
<div style="display:flex;align-items:center;gap:10px;margin-bottom:8px"><span style="font-size:12px;min-width:70px">âš ï¸ Revisar</span><div style="flex:1;height:8px;background:var(--bg);border-radius:4px"><div style="height:100%;width:${U.pct(review.length,clients.length)}%;background:var(--orange);border-radius:4px"></div></div><span style="font-size:12px;font-weight:600">${review.length}</span></div>
<div style="display:flex;align-items:center;gap:10px"><span style="font-size:12px;min-width:70px">ğŸš¨ Riesgo</span><div style="flex:1;height:8px;background:var(--bg);border-radius:4px"><div style="height:100%;width:${U.pct(risk.length,clients.length)}%;background:var(--red);border-radius:4px"></div></div><span style="font-size:12px;font-weight:600">${risk.length}</span></div>
</div>
<div class="card"><div class="card-title mb-1">ğŸ’° Top MRR</div>${clients.sort((a,b)=>(b.mrr||0)-(a.mrr||0)).slice(0,4).map((c,i)=>`<div class="list-item" onclick="openDetail('client','${c.id}')"><span style="font-size:14px">${['ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰','4ï¸âƒ£'][i]}</span><div class="item-content"><div class="item-title">${c.name}</div><div class="item-meta"><span>${(c.services||[]).join(', ')}</span></div></div><span style="color:var(--green);font-weight:600">${U.money(c.mrr)}/m</span></div>`).join('')}</div>
</div>
<div class="grid g2">
<div class="card"><div class="card-header"><div class="card-title">âš ï¸ Requieren atenciÃ³n</div><span class="card-link" onclick="nav('clients')">Ver todos â†’</span></div>${[...review,...risk].slice(0,3).map(c=>clientCard(c)).join('')||'<div class="empty">Todos OK ğŸ‘</div>'}</div>
<div class="card"><div class="card-header"><div class="card-title">ğŸ¤– Pendientes evaluar IA</div></div>${noAI.slice(0,3).map(c=>`<div class="list-item" onclick="openDetail('client','${c.id}')"><div class="item-content"><div class="item-title">${c.name}</div><div class="item-meta"><span>${(c.services||[]).join(', ')}</span></div></div><button class="btn btn-sm btn-secondary" onclick="event.stopPropagation();editClientAI('${c.id}')">Evaluar</button></div>`).join('')||'<div class="empty">Todos evaluados âœ“</div>'}</div>
</div></div>`}

function pgDashProducto(){
const opps=DB.data.opportunities;const projects=DB.data.projects;const decs=DB.data.decisions;const inbox=(DB.data.inbox||[]).filter(i=>!i.processed);const activeOpps=opps.filter(o=>!['launched','discarded'].includes(o.status));const activeProjs=projects.filter(p=>p.status==='active');const totalPotential=activeOpps.reduce((s,o)=>s+(o.potential||0),0);
return`<div class="page active"><div class="page-header"><div><h1>ğŸ¯ Dashboard Producto</h1><p>Estrategia y desarrollo</p></div><div class="actions"><button class="btn btn-secondary" onclick="showInboxModal()">ğŸ“¥ Idea</button><button class="btn btn-primary" onclick="showOppModal()">+ Oportunidad</button></div></div>
<div class="grid g4 mb-2">
<div class="stat" onclick="nav('opportunities')"><div class="stat-icon yellow">ğŸ’¡</div><div class="stat-value">${activeOpps.length}</div><div class="stat-label">Oportunidades</div></div>
<div class="stat"><div class="stat-icon green">ğŸ’°</div><div class="stat-value">${U.money(totalPotential)}</div><div class="stat-label">Potencial</div></div>
<div class="stat" onclick="nav('projects')"><div class="stat-icon purple">ğŸ¯</div><div class="stat-value">${activeProjs.length}</div><div class="stat-label">Proyectos activos</div></div>
<div class="stat" onclick="nav('decisions')"><div class="stat-icon orange">âš¡</div><div class="stat-value">${decs.filter(d=>!d.decided).length}</div><div class="stat-label">Decisiones</div></div>
</div>
<div class="grid g2 mb-2">
<div class="card"><div class="card-title mb-1">ğŸ’¡ Pipeline oportunidades</div>${OPP_ST.slice(0,4).map(st=>{const count=opps.filter(o=>o.status===st.id).length;return`<div style="display:flex;align-items:center;gap:10px;margin-bottom:8px"><span style="font-size:12px;min-width:100px">${st.icon} ${st.name}</span><div style="flex:1;height:8px;background:var(--bg);border-radius:4px"><div style="height:100%;width:${count*25}%;background:var(--accent);border-radius:4px"></div></div><span style="font-size:12px;font-weight:600">${count}</span></div>`}).join('')}</div>
<div class="card"><div class="card-title mb-1">ğŸ¯ Progreso proyectos</div>${activeProjs.slice(0,3).map(p=>`<div style="display:flex;align-items:center;gap:10px;margin-bottom:8px"><span style="font-size:12px;min-width:100px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${p.title}</span><div style="flex:1;height:8px;background:var(--bg);border-radius:4px"><div style="height:100%;width:${p.progress}%;background:${U.progCol(p.progress)};border-radius:4px"></div></div><span style="font-size:12px;font-weight:600">${p.progress}%</span></div>`).join('')||'<div class="empty">Sin proyectos activos</div>'}</div>
</div>
<div class="grid g2">
<div class="card"><div class="card-header"><div class="card-title">ğŸ’¡ Oportunidades</div><span class="card-link" onclick="nav('opportunities')">Ver todas â†’</span></div>${activeOpps.slice(0,3).map(o=>oppCard(o)).join('')||'<div class="empty">Sin oportunidades</div>'}</div>
<div class="card"><div class="card-header"><div class="card-title">ğŸ“¥ Ideas producto</div><span class="card-link" onclick="nav('inbox')">Ver inbox â†’</span></div>${inbox.filter(i=>(i.tags||[]).some(t=>['producto','mercado'].includes(t))).slice(0,3).map(i=>inboxItem(i)).join('')||'<div class="empty">Sin ideas de producto</div>'}</div>
</div></div>`}

function pgDashEquipo(){
const users=DB.data.users;const tasks=DB.data.tasks;const pendingTasks=tasks.filter(t=>t.status!=='done');const inProgress=tasks.filter(t=>t.status==='in-progress');const inbox=(DB.data.inbox||[]).filter(i=>!i.processed&&(i.tags||[]).includes('equipo'));
return`<div class="page active"><div class="page-header"><div><h1>ğŸ§‘â€ğŸ¤â€ğŸ§‘ Dashboard Equipo</h1><p>Carga de trabajo y capacidad</p></div><div class="actions"><button class="btn btn-primary" onclick="showTaskModal()">+ Asignar tarea</button></div></div>
<div class="grid g4 mb-2">
<div class="stat" onclick="nav('team')"><div class="stat-icon blue">ğŸ‘¥</div><div class="stat-value">${users.length}</div><div class="stat-label">Miembros</div></div>
<div class="stat" onclick="nav('tasks')"><div class="stat-icon orange">ğŸ“‹</div><div class="stat-value">${pendingTasks.length}</div><div class="stat-label">Tareas pendientes</div></div>
<div class="stat"><div class="stat-icon cyan">ğŸ”„</div><div class="stat-value">${inProgress.length}</div><div class="stat-label">En progreso</div></div>
<div class="stat"><div class="stat-icon green">âœ…</div><div class="stat-value">${tasks.filter(t=>t.status==='done').length}</div><div class="stat-label">Completadas</div></div>
</div>
<div class="card mb-2"><div class="card-title mb-1">ğŸ“Š Carga por persona</div>
${users.map(u=>{const userTasks=DB.tasksByUser(u.id).filter(t=>t.status!=='done');const maxTasks=8;const pct=Math.min(100,Math.round((userTasks.length/maxTasks)*100));const color=pct>=80?'var(--red)':pct>=50?'var(--orange)':'var(--green)';return`<div style="display:flex;align-items:center;gap:10px;margin-bottom:8px">${avatar(u,'sm')}<span style="font-size:12px;min-width:70px">${u.name}</span><div style="flex:1;height:8px;background:var(--bg);border-radius:4px"><div style="height:100%;width:${pct}%;background:${color};border-radius:4px"></div></div><span style="font-size:12px;font-weight:600">${userTasks.length} tareas</span></div>`}).join('')}
</div>
<div class="grid g2">
<div class="card"><div class="card-header"><div class="card-title">ğŸ”¥ Tareas urgentes</div><span class="card-link" onclick="nav('tasks')">Ver todas â†’</span></div>${pendingTasks.filter(t=>t.priority==='urgent'||t.priority==='high').slice(0,4).map(t=>taskItem(t)).join('')||'<div class="empty">Sin urgencias ğŸ‘</div>'}</div>
<div class="card"><div class="card-header"><div class="card-title">ğŸ‘¥ Temas equipo</div><span class="card-link" onclick="nav('inbox')">Ver inbox â†’</span></div>${inbox.slice(0,3).map(i=>inboxItem(i)).join('')||'<div class="empty">Sin temas pendientes</div>'}</div>
</div></div>`}

function pgOpp(){const opps=DB.data.opportunities.filter(o=>o.status!=='launched');const launched=DB.data.opportunities.filter(o=>o.status==='launched');
return`<div class="page active"><div class="page-header"><div><h1>ğŸ’¡ Oportunidades</h1><p>Ideas para escalar WEDO</p></div><div class="actions"><button class="btn btn-primary" onclick="showOppModal()">+ Nueva</button></div></div>
<div class="qstats"><div class="qstat"><div class="qstat-val">${opps.length}</div><div class="qstat-lbl">Activas</div></div><div class="qstat"><div class="qstat-val text-success">${U.money(opps.reduce((s,o)=>s+(o.potential||0),0))}</div><div class="qstat-lbl">Potencial</div></div></div>
<div class="grid g2">${opps.map(oppCard).join('')}</div>
${launched.length?`<h3 class="mt-2 mb-1" style="font-size:13px;color:var(--text2)">ğŸ‰ Lanzadas</h3><div class="grid g2">${launched.map(oppCard).join('')}</div>`:''}</div>`}

function pgDec(){const pending=DB.data.decisions.filter(d=>!d.decided);const decided=DB.data.decisions.filter(d=>d.decided);
return`<div class="page active"><div class="page-header"><div><h1>âš¡ Decisiones</h1><p>Cosas que decidir</p></div><div class="actions"><button class="btn btn-primary" onclick="showDecModal()">+ Nueva</button></div></div>
<div class="qstats"><div class="qstat"><div class="qstat-val text-warning">${pending.length}</div><div class="qstat-lbl">Pendientes</div></div><div class="qstat"><div class="qstat-val text-success">${decided.length}</div><div class="qstat-lbl">Decididas</div></div></div>
<h3 class="mb-1" style="font-size:13px">â³ Pendientes</h3><div class="grid g2 mb-2">${pending.length?pending.map(decCard).join(''):'<div class="empty">Nada pendiente</div>'}</div>
${decided.length?`<h3 class="mb-1" style="font-size:13px">âœ… Decididas</h3><div class="grid g2">${decided.map(decCard).join('')}</div>`:''}</div>`}

function pgProj(){return`<div class="page active"><div class="page-header"><div><h1>ğŸ¯ Proyectos WEDO</h1><p>Proyectos internos</p></div><div class="actions"><button class="btn btn-primary" onclick="showProjModal()">+ Nuevo</button></div></div>
<div class="grid g2">${DB.data.projects.map(projCard).join('')}</div></div>`}

function pgCom(){const s=DB.stats();const stages=STAGES.filter(st=>!['won','lost'].includes(st.id));const won=DB.byStage('won'),lost=DB.byStage('lost');
return`<div class="page active"><div class="page-header"><div><h1>ğŸ’¼ Comercial</h1><p>Pipeline de ventas</p></div><div class="actions"><button class="btn btn-secondary" onclick="nav('referrers')">ğŸ‘¥ Referidores</button><button class="btn btn-primary" onclick="showLeadModal()">+ Lead</button></div></div>
<div class="qstats"><div class="qstat"><div class="qstat-val">${s.activeLeads}</div><div class="qstat-lbl">Leads</div></div><div class="qstat"><div class="qstat-val text-success">${U.money(s.pipeline)}</div><div class="qstat-lbl">Pipeline</div></div><div class="qstat"><div class="qstat-val">${won.length}</div><div class="qstat-lbl">Ganados</div></div><div class="qstat"><div class="qstat-val">${U.money(s.won)}</div><div class="qstat-lbl">Facturado</div></div><div class="qstat"><div class="qstat-val">${U.pct(won.length,won.length+lost.length)}%</div><div class="qstat-lbl">ConversiÃ³n</div></div></div>
<div class="funnel">${stages.map(st=>{const leads=DB.byStage(st.id);return`<div class="funnel-col"><div class="funnel-header"><div class="funnel-title" style="color:${st.color}">${st.icon} ${st.name} <span class="funnel-count">${leads.length}</span></div><span style="font-size:10px;color:var(--muted)">${U.money(leads.reduce((s,l)=>s+(l.value||0),0))}</span></div><div class="funnel-body" ondragover="event.preventDefault()" ondrop="dropLead(event,'${st.id}')">${leads.map(leadCard).join('')}<button class="funnel-add" onclick="showLeadModal(null,'${st.id}')">+</button></div></div>`}).join('')}</div>
<div class="grid g2 mt-2"><div class="card" style="border-left:3px solid var(--green)"><div class="card-title mb-1">âœ… Cerrados (${won.length})</div>${won.slice(0,3).map(leadCard).join('')||'<div class="empty">-</div>'}</div><div class="card" style="border-left:3px solid var(--red)"><div class="card-title mb-1">âŒ Perdidos (${lost.length})</div>${lost.slice(0,3).map(leadCard).join('')||'<div class="empty">-</div>'}</div></div></div>`}

function pgRef(){const refs=DB.data.referrers;const total=DB.data.leads.filter(l=>l.referrerId).length;const wonRef=DB.data.leads.filter(l=>l.referrerId&&l.stage==='won');const val=wonRef.reduce((s,l)=>s+(l.value||0),0);
return`<div class="page active"><div class="page-header"><div><h1>ğŸ‘¥ Referidores</h1></div><div class="actions"><button class="btn btn-secondary" onclick="nav('comercial')">â† Comercial</button><button class="btn btn-primary" onclick="showRefModal()">+ Referidor</button></div></div>
<div class="qstats"><div class="qstat"><div class="qstat-val">${refs.length}</div><div class="qstat-lbl">Referidores</div></div><div class="qstat"><div class="qstat-val">${total}</div><div class="qstat-lbl">Leads</div></div><div class="qstat"><div class="qstat-val text-success">${wonRef.length}</div><div class="qstat-lbl">Cerrados</div></div><div class="qstat"><div class="qstat-val text-success">${U.money(val)}</div><div class="qstat-lbl">Generado</div></div></div>
<div class="card"><div class="card-title mb-1">ğŸ† Ranking</div>${refs.sort((a,b)=>{const av=DB.byRef(a.id).filter(l=>l.stage==='won').reduce((s,l)=>s+(l.value||0),0);const bv=DB.byRef(b.id).filter(l=>l.stage==='won').reduce((s,l)=>s+(l.value||0),0);return bv-av}).map((r,i)=>{const lds=DB.byRef(r.id);const w=lds.filter(l=>l.stage==='won');const v=w.reduce((s,l)=>s+(l.value||0),0);return`<div class="list-item" onclick="editRef('${r.id}')"><span style="font-size:16px">${['ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰'][i]||'â–ªï¸'}</span><div class="avatar sm" style="background:linear-gradient(135deg,var(--cyan),var(--blue))">${r.name[0]}</div><div class="item-content"><div class="item-title">${r.name}</div><div class="item-meta"><span>${lds.length} leads</span><span>${w.length} cerrados</span></div></div><span style="font-weight:700;color:var(--green)">${U.money(v)}</span></div>`}).join('')}</div></div>`}

function pgTasks(){const tasks=DB.data.tasks;const users=DB.data.users;const p=tasks.filter(t=>t.status==='pending'),ip=tasks.filter(t=>t.status==='in-progress'),d=tasks.filter(t=>t.status==='done');
return`<div class="page active"><div class="page-header"><div><h1>âœ… Tareas</h1><p>Todas las tareas sincronizadas</p></div><div class="actions"><button class="btn btn-primary" onclick="showTaskModal()">+ Tarea</button></div></div>
<div class="pills" id="taskFilters">
<button class="pill active" onclick="filterTasks('all',this)">Todas (${tasks.length})</button>
${users.map(u=>`<button class="pill" onclick="filterTasks('${u.id}',this)">${u.initials} (${DB.tasksByUser(u.id).filter(t=>t.status!=='done').length})</button>`).join('')}
<button class="pill" onclick="filterTasks('none',this)">Sin asignar (${tasks.filter(t=>!t.assignee&&t.status!=='done').length})</button>
</div>
<div id="tasksGrid" class="grid g3"><div class="card"><div class="card-title mb-1">ğŸ“‹ Pendientes (${p.length})</div>${p.length?p.map(t=>taskItem(t)).join(''):'<div class="empty">-</div>'}</div><div class="card"><div class="card-title mb-1">ğŸ”„ En progreso (${ip.length})</div>${ip.length?ip.map(t=>taskItem(t)).join(''):'<div class="empty">-</div>'}</div><div class="card"><div class="card-title mb-1">âœ… Hechas (${d.length})</div>${d.length?d.slice(0,8).map(t=>taskItem(t)).join(''):'<div class="empty">-</div>'}</div></div></div>`}

function filterTasks(f,btn){
document.querySelectorAll('#taskFilters .pill').forEach(p=>p.classList.remove('active'));
btn.classList.add('active');
let tasks=DB.data.tasks;
if(f==='none')tasks=tasks.filter(t=>!t.assignee);
else if(f!=='all')tasks=tasks.filter(t=>t.assignee===f);
const p=tasks.filter(t=>t.status==='pending'),ip=tasks.filter(t=>t.status==='in-progress'),d=tasks.filter(t=>t.status==='done');
document.getElementById('tasksGrid').innerHTML=`<div class="card"><div class="card-title mb-1">ğŸ“‹ Pendientes (${p.length})</div>${p.length?p.map(t=>taskItem(t)).join(''):'<div class="empty">-</div>'}</div><div class="card"><div class="card-title mb-1">ğŸ”„ En progreso (${ip.length})</div>${ip.length?ip.map(t=>taskItem(t)).join(''):'<div class="empty">-</div>'}</div><div class="card"><div class="card-title mb-1">âœ… Hechas (${d.length})</div>${d.length?d.slice(0,8).map(t=>taskItem(t)).join(''):'<div class="empty">-</div>'}</div>`;
}

// ============ OBJETIVOS ============
function pgObjectives(){
const objs=DB.data.objectives||[];
const year=new Date().getFullYear();
const yearObjs=objs.filter(o=>o.year===year);
const avgProgress=yearObjs.length?Math.round(yearObjs.reduce((s,o)=>s+U.pct(o.current,o.target),0)/yearObjs.length):0;

return`<div class="page active"><div class="page-header"><div><h1>ğŸ¯ Objetivos ${year}</h1><p>PlanificaciÃ³n estratÃ©gica anual</p></div><div class="actions"><button class="btn btn-primary" onclick="showObjModal()">+ Objetivo</button></div></div>
<div class="qstats">
<div class="qstat"><div class="qstat-val">${yearObjs.length}</div><div class="qstat-lbl">Objetivos</div></div>
<div class="qstat"><div class="qstat-val" style="color:${U.progCol(avgProgress)}">${avgProgress}%</div><div class="qstat-lbl">Progreso</div></div>
<div class="qstat"><div class="qstat-val text-success">${yearObjs.filter(o=>U.pct(o.current,o.target)>=100).length}</div><div class="qstat-lbl">Conseguidos</div></div>
<div class="qstat"><div class="qstat-val text-warning">${yearObjs.filter(o=>U.pct(o.current,o.target)<50).length}</div><div class="qstat-lbl">En riesgo</div></div>
</div>
<div class="grid g2">${yearObjs.map(o=>objCard(o)).join('')||'<div class="empty">Sin objetivos definidos</div>'}</div>
</div>`}

function objCard(o){
const area=OBJ_AREAS.find(a=>a.id===o.area);
const pct=U.pct(o.current,o.target);
const krs=o.keyResults||[];
const krsProgress=krs.length?Math.round(krs.reduce((s,k)=>s+U.pct(k.current,k.target),0)/krs.length):0;
return`<div class="project-card" onclick="openDetail('obj','${o.id}')" style="border-left-color:${area?.color||'var(--accent)'}">
<div style="display:flex;justify-content:space-between;align-items:start">
<div class="project-title">${o.title}</div>
<span class="tag" style="background:${area?.color}22;color:${area?.color}">${area?.icon} ${area?.name}</span>
</div>
<div class="progress-bar mt-1" style="height:8px"><div class="progress-fill" style="width:${pct}%;background:${U.progCol(pct)}"></div></div>
<div class="project-footer mt-1">
<span>${o.current} / ${o.target} ${o.unit}</span>
<span style="font-weight:600;color:${U.progCol(pct)}">${pct}%</span>
</div>
<div style="margin-top:8px;font-size:11px;color:var(--muted)">${krs.length} Key Results Â· ${krsProgress}% completado</div>
</div>`}

function pgObjDetail(id){
const o=(DB.data.objectives||[]).find(x=>x.id===id);
if(!o)return'<div class="empty">No encontrado</div>';
const area=OBJ_AREAS.find(a=>a.id===o.area);
const pct=U.pct(o.current,o.target);
const krs=o.keyResults||[];

return`<div class="page active">
<div class="back-btn" onclick="closeDetail()">â† Volver a Objetivos</div>
<div class="detail-header">
<div style="display:flex;justify-content:space-between;align-items:start;flex-wrap:wrap;gap:10px">
<div>
<div class="detail-title">ğŸ¯ ${o.title}</div>
<div class="detail-desc">${o.current} / ${o.target} ${o.unit}</div>
</div>
<div class="actions">
<button class="btn btn-secondary btn-sm" onclick="editObjInfo('${o.id}')">âœï¸ Editar</button>
</div>
</div>
<div class="progress-bar mt-1" style="height:10px"><div class="progress-fill" style="width:${pct}%;background:${U.progCol(pct)}"></div></div>
<div class="detail-meta mt-1">
<div class="detail-meta-item"><span class="tag" style="background:${area?.color}22;color:${area?.color}">${area?.icon} ${area?.name}</span></div>
<div class="detail-meta-item"><span>ğŸ“…</span>${o.year}</div>
<div class="detail-meta-item"><span style="font-weight:700;color:${U.progCol(pct)}">${pct}% completado</span></div>
</div>
</div>
<div class="card">
<div class="card-header"><div class="card-title">ğŸ“Š Key Results</div><button class="btn btn-primary btn-sm" onclick="showKRModal('${o.id}')">+ AÃ±adir KR</button></div>
${krs.length?krs.map(kr=>{
const krPct=U.pct(kr.current,kr.target);
return`<div class="list-item" onclick="editKR('${o.id}','${kr.id}')">
<div class="item-content" style="flex:1">
<div class="item-title">${kr.title}</div>
<div class="progress-bar mt-1" style="height:6px"><div class="progress-fill" style="width:${krPct}%;background:${U.progCol(krPct)}"></div></div>
</div>
<div style="text-align:right;min-width:80px">
<div style="font-size:13px;font-weight:600">${kr.current}/${kr.target}</div>
<div style="font-size:11px;color:${U.progCol(krPct)}">${krPct}%</div>
</div>
</div>`}).join(''):'<div class="empty">Sin Key Results. Â¡AÃ±ade el primero!</div>'}
</div>
</div>`}

function pgTeam(){return`<div class="page active"><div class="page-header"><div><h1>ğŸ‘¥ Equipo</h1></div><div class="actions"><button class="btn btn-primary" onclick="showUserModal()">+ Miembro</button></div></div>
<div class="grid g4">${DB.data.users.map(u=>{const tasks=DB.tasksByUser(u.id).filter(t=>t.status!=='done').length;return`<div class="member" onclick="editUser('${u.id}')">${avatar(u,'xl')}<div class="member-name">${u.name}</div><div class="member-role">${u.role}</div><div style="margin-top:8px;font-size:12px"><strong>${tasks}</strong> tareas</div></div>`}).join('')}</div></div>`}

function pgSet(){const co=DB.data.company;const me=DB.me();return`<div class="page active"><div class="page-header"><div><h1>âš™ï¸ Config</h1></div></div>
<div class="grid g2"><div class="card"><div class="card-title mb-1">ğŸ‘¤ Mi perfil</div><form id="profileForm" onsubmit="saveProfile(event)"><div class="form-group"><label class="form-label">Nombre</label><input class="form-input" name="name" value="${me.name}" required></div><div class="form-group"><label class="form-label">Cargo</label><input class="form-input" name="role" value="${me.role}"></div><button type="submit" class="btn btn-primary" style="width:100%">Guardar</button></form></div>
<div class="card"><div class="card-title mb-1">ğŸ¢ Empresa</div><form id="companyForm" onsubmit="saveCo(event)"><div class="form-group"><label class="form-label">Nombre</label><input class="form-input" name="name" value="${co.name}" required></div><div class="form-group"><label class="form-label">Logo</label><input class="form-input" name="logo" value="${co.logo}" maxlength="2"></div><button type="submit" class="btn btn-primary" style="width:100%">Guardar</button></form><div style="margin-top:16px;padding-top:16px;border-top:1px solid var(--border)"><button class="btn btn-danger btn-sm" onclick="confirmReset()">ğŸ—‘ï¸ Reset</button></div></div></div></div>`}

// Drag
let dragId=null;
function dragLead(e,id){dragId=id;e.dataTransfer.effectAllowed='move'}
function dropLead(e,stage){e.preventDefault();if(dragId){DB.update('leads',dragId,{stage});UI.toast('Movido');render();dragId=null}}

// ============ MODALS ============
function showOppModal(o=null){const ed=o!==null;const users=DB.data.users;UI.modal(ed?'Editar':'Nueva oportunidad',`<form id="oppForm"><div class="form-group"><label class="form-label">TÃ­tulo *</label><input class="form-input" name="title" value="${o?.title||''}" required></div><div class="form-group"><label class="form-label">DescripciÃ³n</label><textarea class="form-textarea" name="desc">${o?.desc||''}</textarea></div><div class="form-row"><div class="form-group"><label class="form-label">Estado</label><select class="form-select" name="status">${OPP_ST.map(s=>`<option value="${s.id}" ${o?.status===s.id?'selected':''}>${s.icon} ${s.name}</option>`).join('')}</select></div><div class="form-group"><label class="form-label">Potencial â‚¬</label><input type="number" class="form-input" name="potential" value="${o?.potential||''}"></div></div><div class="form-row"><div class="form-group"><label class="form-label">Esfuerzo</label><select class="form-select" name="effort"><option value="low" ${o?.effort==='low'?'selected':''}>Bajo</option><option value="medium" ${o?.effort==='medium'?'selected':''}>Medio</option><option value="high" ${o?.effort==='high'?'selected':''}>Alto</option></select></div><div class="form-group"><label class="form-label">Responsable</label><select class="form-select" name="lead">${users.map(u=>`<option value="${u.id}" ${o?.lead===u.id?'selected':''}>${u.name}</option>`).join('')}</select></div></div><input type="hidden" name="id" value="${o?.id||''}"></form>`,`${ed?`<button class="btn btn-danger" onclick="delOpp('${o.id}')">Eliminar</button>`:''}<button class="btn btn-secondary" onclick="UI.closeModal()">Cancelar</button><button class="btn btn-primary" onclick="saveOpp()">Guardar</button>`,'lg')}
function saveOpp(){const f=document.getElementById('oppForm');const d=Object.fromEntries(new FormData(f));if(!d.title?.trim())return UI.toast('TÃ­tulo requerido','error');d.potential=parseInt(d.potential)||0;if(d.id){DB.update('opportunities',d.id,d);UI.toast('Actualizado')}else{delete d.id;DB.add('opportunities',d);UI.toast('Creada')}UI.closeModal();render()}
function editOppInfo(id){showOppModal(DB.get('opportunities',id))}
function delOpp(id){UI.confirm('Â¿Eliminar? Las tareas asociadas quedarÃ¡n sin vincular.',`function(){DB.data.tasks.forEach(t=>{if(t.oppId==='${id}')t.oppId=null});DB.del('opportunities','${id}');UI.toast('Eliminada');UI.closeModal();closeDetail()}`)}

function showDecModal(d=null){const ed=d!==null;UI.modal(ed?'Editar':'Nueva decisiÃ³n',`<form id="decForm"><div class="form-group"><label class="form-label">Â¿QuÃ© decidir? *</label><input class="form-input" name="title" value="${d?.title||''}" required></div><div class="form-group"><label class="form-label">Contexto</label><textarea class="form-textarea" name="context">${d?.context||''}</textarea></div><div class="form-group"><label class="form-label">Opciones</label><textarea class="form-textarea" name="options">${d?.options||''}</textarea></div><div class="form-group"><label class="form-label">Deadline</label><input type="date" class="form-input" name="deadline" value="${d?.deadline||''}"></div>${ed?`<div class="form-group"><label><input type="checkbox" name="decided" ${d?.decided?'checked':''} style="margin-right:6px">Decidido</label></div><div class="form-group"><label class="form-label">DecisiÃ³n</label><input class="form-input" name="decision" value="${d?.decision||''}"></div>`:''}<input type="hidden" name="id" value="${d?.id||''}"></form>`,`${ed?`<button class="btn btn-danger" onclick="delDec('${d.id}')">Eliminar</button>`:''}<button class="btn btn-secondary" onclick="UI.closeModal()">Cancelar</button><button class="btn btn-primary" onclick="saveDec()">Guardar</button>`,'lg')}
function saveDec(){const f=document.getElementById('decForm');const d=Object.fromEntries(new FormData(f));if(!d.title?.trim())return UI.toast('TÃ­tulo requerido','error');d.decided=d.decided==='on';if(d.id){DB.update('decisions',d.id,d);UI.toast('Actualizado')}else{delete d.id;d.decided=false;DB.add('decisions',d);UI.toast('AÃ±adida')}UI.closeModal();render()}
function editDec(id){showDecModal(DB.get('decisions',id))}
function delDec(id){UI.confirm('Â¿Eliminar?',`function(){DB.del('decisions','${id}');UI.toast('Eliminada');UI.closeModal();render()}`)}

function showProjModal(p=null){const ed=p!==null;const users=DB.data.users;UI.modal(ed?'Editar':'Nuevo proyecto',`<form id="projForm"><div class="form-group"><label class="form-label">Nombre *</label><input class="form-input" name="title" value="${p?.title||''}" required></div><div class="form-group"><label class="form-label">DescripciÃ³n</label><textarea class="form-textarea" name="desc">${p?.desc||''}</textarea></div><div class="form-row"><div class="form-group"><label class="form-label">Estado</label><select class="form-select" name="status">${PROJ_ST.map(s=>`<option value="${s.id}" ${p?.status===s.id?'selected':''}>${s.name}</option>`).join('')}</select></div><div class="form-group"><label class="form-label">Responsable</label><select class="form-select" name="lead">${users.map(u=>`<option value="${u.id}" ${p?.lead===u.id?'selected':''}>${u.name}</option>`).join('')}</select></div></div><div class="form-row"><div class="form-group"><label class="form-label">Progreso %</label><input type="number" class="form-input" name="progress" value="${p?.progress||0}" min="0" max="100"></div><div class="form-group"><label class="form-label">Fecha</label><input type="date" class="form-input" name="due" value="${p?.due||''}"></div></div><input type="hidden" name="id" value="${p?.id||''}"></form>`,`${ed?`<button class="btn btn-danger" onclick="delProj('${p.id}')">Eliminar</button>`:''}<button class="btn btn-secondary" onclick="UI.closeModal()">Cancelar</button><button class="btn btn-primary" onclick="saveProj()">Guardar</button>`,'lg')}
function saveProj(){const f=document.getElementById('projForm');const d=Object.fromEntries(new FormData(f));if(!d.title?.trim())return UI.toast('TÃ­tulo requerido','error');d.progress=parseInt(d.progress)||0;if(d.id){DB.update('projects',d.id,d);UI.toast('Actualizado')}else{delete d.id;DB.add('projects',d);UI.toast('Creado')}UI.closeModal();render()}
function editProjInfo(id){showProjModal(DB.get('projects',id))}
function delProj(id){UI.confirm('Â¿Eliminar? Las tareas asociadas quedarÃ¡n sin vincular.',`function(){DB.data.tasks.forEach(t=>{if(t.projectId==='${id}')t.projectId=null});DB.del('projects','${id}');UI.toast('Eliminado');UI.closeModal();closeDetail()}`)}

function showLeadModal(l=null,defStage='new'){const ed=l!==null;const users=DB.data.users;const refs=DB.data.referrers;UI.modal(ed?'Editar':'Nuevo lead',`<form id="leadForm"><div class="form-row"><div class="form-group"><label class="form-label">Nombre *</label><input class="form-input" name="name" value="${l?.name||''}" required></div><div class="form-group"><label class="form-label">Empresa</label><input class="form-input" name="company" value="${l?.company||''}"></div></div><div class="form-row"><div class="form-group"><label class="form-label">Valor â‚¬</label><input type="number" class="form-input" name="value" value="${l?.value||''}"></div><div class="form-group"><label class="form-label">Etapa</label><select class="form-select" name="stage">${STAGES.map(s=>`<option value="${s.id}" ${(l?.stage||defStage)===s.id?'selected':''}>${s.icon} ${s.name}</option>`).join('')}</select></div></div><div class="form-row"><div class="form-group"><label class="form-label">Origen</label><select class="form-select" name="source">${SOURCES.map(s=>`<option value="${s.id}" ${l?.source===s.id?'selected':''}>${s.name}</option>`).join('')}</select></div><div class="form-group"><label class="form-label">Referidor</label><select class="form-select" name="referrerId"><option value="">-</option>${refs.map(r=>`<option value="${r.id}" ${l?.referrerId===r.id?'selected':''}>${r.name}</option>`).join('')}</select></div></div><div class="form-group"><label class="form-label">Asignado</label><select class="form-select" name="assignee">${users.map(u=>`<option value="${u.id}" ${l?.assignee===u.id?'selected':''}>${u.name}</option>`).join('')}</select></div><input type="hidden" name="id" value="${l?.id||''}"></form>`,`${ed?`<button class="btn btn-danger" onclick="delLead('${l.id}')">Eliminar</button>`:''}<button class="btn btn-secondary" onclick="UI.closeModal()">Cancelar</button><button class="btn btn-primary" onclick="saveLead()">Guardar</button>`,'lg')}
function saveLead(){const f=document.getElementById('leadForm');const d=Object.fromEntries(new FormData(f));if(!d.name?.trim())return UI.toast('Nombre requerido','error');d.value=parseInt(d.value)||0;d.referrerId=d.referrerId||null;if(d.id){DB.update('leads',d.id,d);UI.toast('Actualizado')}else{delete d.id;DB.add('leads',d);UI.toast('Creado')}UI.closeModal();render()}
function editLead(id){showLeadModal(DB.get('leads',id))}
function delLead(id){UI.confirm('Â¿Eliminar?',`function(){DB.del('leads','${id}');UI.toast('Eliminado');UI.closeModal();render()}`)}

function showRefModal(r=null){const ed=r!==null;UI.modal(ed?'Editar':'Nuevo referidor',`<form id="refForm"><div class="form-group"><label class="form-label">Nombre *</label><input class="form-input" name="name" value="${r?.name||''}" required></div><div class="form-group"><label class="form-label">Empresa</label><input class="form-input" name="company" value="${r?.company||''}"></div><div class="form-group"><label class="form-label">Tipo</label><select class="form-select" name="type"><option value="partner" ${r?.type==='partner'?'selected':''}>Partner</option><option value="client" ${r?.type==='client'?'selected':''}>Cliente</option><option value="contact" ${r?.type==='contact'?'selected':''}>Contacto</option></select></div><input type="hidden" name="id" value="${r?.id||''}"></form>`,`${ed?`<button class="btn btn-danger" onclick="delRef('${r.id}')">Eliminar</button>`:''}<button class="btn btn-secondary" onclick="UI.closeModal()">Cancelar</button><button class="btn btn-primary" onclick="saveRef()">Guardar</button>`)}
function saveRef(){const f=document.getElementById('refForm');const d=Object.fromEntries(new FormData(f));if(!d.name?.trim())return UI.toast('Nombre requerido','error');if(d.id){DB.update('referrers',d.id,d);UI.toast('Actualizado')}else{delete d.id;DB.add('referrers',d);UI.toast('AÃ±adido')}UI.closeModal();render()}
function editRef(id){showRefModal(DB.get('referrers',id))}
function delRef(id){UI.confirm('Â¿Eliminar?',`function(){DB.del('referrers','${id}');DB.data.leads.forEach(l=>{if(l.referrerId==='${id}')l.referrerId=null});DB.save();UI.toast('Eliminado');UI.closeModal();render()}`)}

// Task modal con contexto opcional (opp o proj)
function showTaskModal(t=null,contextType=null,contextId=null){
const ed=t!==null;
const users=DB.data.users;
const opps=DB.data.opportunities;
const projs=DB.data.projects;
const preOpp=contextType==='opp'?contextId:(t?.oppId||'');
const preProj=contextType==='proj'?contextId:(t?.projectId||'');

UI.modal(ed?'Editar tarea':'Nueva tarea',`<form id="taskForm"><div class="form-group"><label class="form-label">TÃ­tulo *</label><input class="form-input" name="title" value="${t?.title||''}" required></div><div class="form-row"><div class="form-group"><label class="form-label">Asignar</label><select class="form-select" name="assignee"><option value="">-</option>${users.map(u=>`<option value="${u.id}" ${t?.assignee===u.id?'selected':''}>${u.name}</option>`).join('')}</select></div><div class="form-group"><label class="form-label">Prioridad</label><select class="form-select" name="priority"><option value="low" ${t?.priority==='low'?'selected':''}>Baja</option><option value="medium" ${t?.priority==='medium'?'selected':''}>Media</option><option value="high" ${t?.priority==='high'?'selected':''}>Alta</option><option value="urgent" ${t?.priority==='urgent'?'selected':''}>Urgente</option></select></div></div><div class="form-group"><label class="form-label">Fecha</label><input type="date" class="form-input" name="due" value="${t?.due||''}"></div><div class="form-row"><div class="form-group"><label class="form-label">ğŸ’¡ Oportunidad</label><select class="form-select" name="oppId"><option value="">-</option>${opps.map(o=>`<option value="${o.id}" ${preOpp===o.id?'selected':''}>${o.title}</option>`).join('')}</select></div><div class="form-group"><label class="form-label">ğŸ¯ Proyecto</label><select class="form-select" name="projectId"><option value="">-</option>${projs.map(p=>`<option value="${p.id}" ${preProj===p.id?'selected':''}>${p.title}</option>`).join('')}</select></div></div>${ed?`<div class="form-group"><label class="form-label">Estado</label><select class="form-select" name="status"><option value="pending" ${t?.status==='pending'?'selected':''}>Pendiente</option><option value="in-progress" ${t?.status==='in-progress'?'selected':''}>En progreso</option><option value="done" ${t?.status==='done'?'selected':''}>Hecha</option></select></div>`:''}<input type="hidden" name="id" value="${t?.id||''}"></form>`,`${ed?`<button class="btn btn-danger" onclick="delTask('${t.id}')">Eliminar</button>`:''}<button class="btn btn-secondary" onclick="UI.closeModal()">Cancelar</button><button class="btn btn-primary" onclick="saveTask()">Guardar</button>`,'lg')}

function saveTask(){const f=document.getElementById('taskForm');const d=Object.fromEntries(new FormData(f));if(!d.title?.trim())return UI.toast('TÃ­tulo requerido','error');d.assignee=d.assignee||null;d.oppId=d.oppId||null;d.projectId=d.projectId||null;if(d.id){DB.update('tasks',d.id,d);UI.toast('Actualizada')}else{delete d.id;d.status='pending';DB.add('tasks',d);UI.toast('Creada')}UI.closeModal();render()}
function editTask(id){showTaskModal(DB.get('tasks',id))}
function toggleTask(id){const t=DB.get('tasks',id);if(t){DB.update('tasks',id,{status:t.status==='done'?'pending':'done'});UI.toast(t.status!=='done'?'âœ“':'Reabierta');render()}}
function delTask(id){UI.confirm('Â¿Eliminar?',`function(){DB.del('tasks','${id}');UI.toast('Eliminada');UI.closeModal();render()}`)}

// ============ INBOX MODALS ============
function showInboxModal(i=null){
const ed=i!==null;
const currentTags=i?.tags||[];
UI.modal(ed?'Editar idea':'Capturar idea',`<form id="inboxForm">
<div class="form-group"><label class="form-label">Â¿QuÃ© estÃ¡s pensando? *</label><textarea class="form-textarea" name="text" required style="min-height:100px">${i?.text||''}</textarea></div>
<div class="form-group"><label class="form-label">Tags</label>
<div style="display:flex;flex-wrap:wrap;gap:6px">${TAGS.map(t=>`<label style="display:flex;align-items:center;gap:4px;padding:6px 10px;background:var(--input);border-radius:6px;cursor:pointer;font-size:12px"><input type="checkbox" name="tags" value="${t.id}" ${currentTags.includes(t.id)?'checked':''}>${t.icon} ${t.name}</label>`).join('')}</div>
</div>
<input type="hidden" name="id" value="${i?.id||''}">
</form>`,`${ed?`<button class="btn btn-danger" onclick="delInbox('${i.id}')">Eliminar</button>`:''}<button class="btn btn-secondary" onclick="UI.closeModal()">Cancelar</button><button class="btn btn-primary" onclick="saveInbox()">Guardar</button>`,'lg')}

function saveInbox(){
const f=document.getElementById('inboxForm');
const fd=new FormData(f);
const d={text:fd.get('text'),tags:fd.getAll('tags'),id:fd.get('id')};
if(!d.text?.trim())return UI.toast('Escribe algo','error');
if(d.id){DB.update('inbox',d.id,d);UI.toast('Actualizado')}
else{delete d.id;d.created=new Date().toISOString().split('T')[0];d.processed=false;DB.add('inbox',d);UI.toast('Capturado')}
UI.closeModal();render()}

function editInbox(id){showInboxModal((DB.data.inbox||[]).find(i=>i.id===id))}
function delInbox(id){UI.confirm('Â¿Eliminar?',`function(){DB.del('inbox','${id}');UI.toast('Eliminado');UI.closeModal();render()}`)}
function processInbox(id){DB.update('inbox',id,{processed:true});UI.toast('Procesado');render()}

function convertInbox(id){
const i=(DB.data.inbox||[]).find(x=>x.id===id);
if(!i)return;
UI.modal('Convertir idea','<p style="margin-bottom:12px;font-size:13px;color:var(--text2)">"'+i.text+'"</p><p style="font-size:13px">Â¿En quÃ© quieres convertirla?</p>',`
<button class="btn btn-secondary" onclick="UI.closeModal()">Cancelar</button>
<button class="btn btn-secondary" onclick="convertTo('opp','${id}')">ğŸ’¡ Oportunidad</button>
<button class="btn btn-secondary" onclick="convertTo('decision','${id}')">âš¡ DecisiÃ³n</button>
<button class="btn btn-secondary" onclick="convertTo('task','${id}')">âœ… Tarea</button>`)}

function convertTo(type,id){
const i=(DB.data.inbox||[]).find(x=>x.id===id);
if(!i)return;
UI.closeModal();
if(type==='opp'){showOppModal({title:i.text,desc:'',status:'idea',potential:0,effort:'medium'})}
else if(type==='decision'){showDecModal({title:i.text,context:'',options:'',deadline:''})}
else if(type==='task'){showTaskModal({title:i.text,priority:'medium'})}
DB.update('inbox',id,{processed:true});
}

// ============ CLIENT MODALS ============
function showClientModal(c=null){
const ed=c!==null;
const currentServices=c?.services||[];
const allServices=['web','seo','paid','social','design','dev','automation'];
UI.modal(ed?'Editar cliente':'Nuevo cliente',`<form id="clientForm">
<div class="form-group"><label class="form-label">Nombre *</label><input class="form-input" name="name" value="${c?.name||''}" required></div>
<div class="form-row">
<div class="form-group"><label class="form-label">MRR (â‚¬/mes)</label><input type="number" class="form-input" name="mrr" value="${c?.mrr||''}"></div>
<div class="form-group"><label class="form-label">Cliente desde</label><input class="form-input" name="since" value="${c?.since||''}" placeholder="2024-01"></div>
</div>
<div class="form-group"><label class="form-label">Estado</label><select class="form-select" name="status">${CLIENT_ST.map(s=>`<option value="${s.id}" ${c?.status===s.id?'selected':''}>${s.name}</option>`).join('')}</select></div>
<div class="form-group"><label class="form-label">Servicios</label>
<div style="display:flex;flex-wrap:wrap;gap:6px">${allServices.map(s=>`<label style="display:flex;align-items:center;gap:4px;padding:6px 10px;background:var(--input);border-radius:6px;cursor:pointer;font-size:12px"><input type="checkbox" name="services" value="${s}" ${currentServices.includes(s)?'checked':''}>${s}</label>`).join('')}</div>
</div>
<div class="form-group"><label class="form-label">ğŸ¤– Necesidades IA</label><input class="form-input" name="aiNeeds" value="${c?.aiNeeds||''}" placeholder="Â¿QuÃ© necesita este cliente en IA?"></div>
<div class="form-group"><label class="form-label">Notas</label><textarea class="form-textarea" name="notes">${c?.notes||''}</textarea></div>
<input type="hidden" name="id" value="${c?.id||''}">
</form>`,`${ed?`<button class="btn btn-danger" onclick="delClient('${c.id}')">Eliminar</button>`:''}<button class="btn btn-secondary" onclick="UI.closeModal()">Cancelar</button><button class="btn btn-primary" onclick="saveClient()">Guardar</button>`,'lg')}

function saveClient(){
const f=document.getElementById('clientForm');
const fd=new FormData(f);
const d={name:fd.get('name'),mrr:parseInt(fd.get('mrr'))||0,since:fd.get('since'),status:fd.get('status'),services:fd.getAll('services'),aiNeeds:fd.get('aiNeeds'),notes:fd.get('notes'),id:fd.get('id')};
if(!d.name?.trim())return UI.toast('Nombre requerido','error');
if(d.id){DB.update('clients',d.id,d);UI.toast('Actualizado')}
else{delete d.id;d.risk='low';DB.add('clients',d);UI.toast('Cliente aÃ±adido')}
UI.closeModal();render()}

function editClientInfo(id){showClientModal((DB.data.clients||[]).find(c=>c.id===id))}
function delClient(id){UI.confirm('Â¿Eliminar cliente?',`function(){DB.del('clients','${id}');UI.toast('Eliminado');UI.closeModal();closeDetail()}`)}

function editClientAI(id){
const c=(DB.data.clients||[]).find(x=>x.id===id);
if(!c)return;
UI.modal('Necesidades IA - '+c.name,`<form id="aiForm"><div class="form-group"><label class="form-label">Â¿QuÃ© necesita este cliente en IA?</label><textarea class="form-textarea" name="aiNeeds" style="min-height:100px">${c.aiNeeds||''}</textarea></div></form>`,`<button class="btn btn-secondary" onclick="UI.closeModal()">Cancelar</button><button class="btn btn-primary" onclick="saveClientAI('${id}')">Guardar</button>`)}

function saveClientAI(id){
const ai=document.querySelector('#aiForm textarea').value;
DB.update('clients',id,{aiNeeds:ai});
UI.toast('Actualizado');UI.closeModal();render()}

function markClientStatus(id,status){DB.update('clients',id,{status});UI.toast('Estado actualizado');render()}

function createIdeaForClient(id){
const c=(DB.data.clients||[]).find(x=>x.id===id);
if(!c)return;
showOppModal({title:'['+c.name+'] ',desc:'',status:'idea',potential:0,effort:'medium'})}

function createTaskForClient(id){
const c=(DB.data.clients||[]).find(x=>x.id===id);
if(!c)return;
showTaskModal({title:'['+c.name+'] ',priority:'medium'})}

// ============ OBJECTIVES MODALS ============
function showObjModal(o=null){
const ed=o!==null;
const year=new Date().getFullYear();
UI.modal(ed?'Editar objetivo':'Nuevo objetivo',`<form id="objForm">
<div class="form-group"><label class="form-label">Objetivo *</label><input class="form-input" name="title" value="${o?.title||''}" required placeholder="Ej: Alcanzar 15K MRR"></div>
<div class="form-row">
<div class="form-group"><label class="form-label">Ãrea</label><select class="form-select" name="area">${OBJ_AREAS.map(a=>`<option value="${a.id}" ${o?.area===a.id?'selected':''}>${a.icon} ${a.name}</option>`).join('')}</select></div>
<div class="form-group"><label class="form-label">AÃ±o</label><input type="number" class="form-input" name="year" value="${o?.year||year}"></div>
</div>
<div class="form-row">
<div class="form-group"><label class="form-label">Meta</label><input type="number" class="form-input" name="target" value="${o?.target||''}" placeholder="100"></div>
<div class="form-group"><label class="form-label">Actual</label><input type="number" class="form-input" name="current" value="${o?.current||0}"></div>
<div class="form-group"><label class="form-label">Unidad</label><input class="form-input" name="unit" value="${o?.unit||''}" placeholder="â‚¬, %, clientes..."></div>
</div>
<input type="hidden" name="id" value="${o?.id||''}">
</form>`,`${ed?`<button class="btn btn-danger" onclick="delObj('${o.id}')">Eliminar</button>`:''}<button class="btn btn-secondary" onclick="UI.closeModal()">Cancelar</button><button class="btn btn-primary" onclick="saveObj()">Guardar</button>`,'lg')}

function saveObj(){
const f=document.getElementById('objForm');
const d=Object.fromEntries(new FormData(f));
if(!d.title?.trim())return UI.toast('TÃ­tulo requerido','error');
d.target=parseInt(d.target)||0;
d.current=parseInt(d.current)||0;
d.year=parseInt(d.year)||new Date().getFullYear();
if(d.id){
const obj=(DB.data.objectives||[]).find(o=>o.id===d.id);
if(obj){d.keyResults=obj.keyResults||[];}
DB.update('objectives',d.id,d);UI.toast('Actualizado');
}else{
delete d.id;d.keyResults=[];
if(!DB.data.objectives)DB.data.objectives=[];
DB.add('objectives',d);UI.toast('Objetivo creado');
}
UI.closeModal();render()}

function editObjInfo(id){showObjModal((DB.data.objectives||[]).find(o=>o.id===id))}
function delObj(id){UI.confirm('Â¿Eliminar objetivo?',`function(){DB.del('objectives','${id}');UI.toast('Eliminado');UI.closeModal();closeDetail()}`)}

function showKRModal(objId,kr=null){
const ed=kr!==null;
UI.modal(ed?'Editar Key Result':'Nuevo Key Result',`<form id="krForm">
<div class="form-group"><label class="form-label">Key Result *</label><input class="form-input" name="title" value="${kr?.title||''}" required placeholder="Ej: Cerrar 5 clientes nuevos"></div>
<div class="form-row">
<div class="form-group"><label class="form-label">Meta</label><input type="number" class="form-input" name="target" value="${kr?.target||''}" placeholder="5"></div>
<div class="form-group"><label class="form-label">Actual</label><input type="number" class="form-input" name="current" value="${kr?.current||0}"></div>
</div>
<input type="hidden" name="id" value="${kr?.id||''}">
<input type="hidden" name="objId" value="${objId}">
</form>`,`${ed?`<button class="btn btn-danger" onclick="delKR('${objId}','${kr?.id}')">Eliminar</button>`:''}<button class="btn btn-secondary" onclick="UI.closeModal()">Cancelar</button><button class="btn btn-primary" onclick="saveKR()">Guardar</button>`)}

function saveKR(){
const f=document.getElementById('krForm');
const d=Object.fromEntries(new FormData(f));
if(!d.title?.trim())return UI.toast('TÃ­tulo requerido','error');
const obj=(DB.data.objectives||[]).find(o=>o.id===d.objId);
if(!obj)return;
if(!obj.keyResults)obj.keyResults=[];
d.target=parseInt(d.target)||0;
d.current=parseInt(d.current)||0;
if(d.id){
const idx=obj.keyResults.findIndex(k=>k.id===d.id);
if(idx>-1)obj.keyResults[idx]={...obj.keyResults[idx],title:d.title,target:d.target,current:d.current};
UI.toast('Actualizado');
}else{
obj.keyResults.push({id:'kr'+Date.now(),title:d.title,target:d.target,current:d.current});
UI.toast('Key Result aÃ±adido');
}
DB.save();UI.closeModal();render()}

function editKR(objId,krId){
const obj=(DB.data.objectives||[]).find(o=>o.id===objId);
if(!obj)return;
const kr=(obj.keyResults||[]).find(k=>k.id===krId);
if(kr)showKRModal(objId,kr);
}

function delKR(objId,krId){
UI.confirm('Â¿Eliminar Key Result?',`function(){
const obj=(DB.data.objectives||[]).find(o=>o.id==='${objId}');
if(obj){obj.keyResults=(obj.keyResults||[]).filter(k=>k.id!=='${krId}');DB.save();}
UI.toast('Eliminado');UI.closeModal();render()}`)}

// ============ CONEXIONES AUTOMÃTICAS ============
function autoCreateTask(title,context){
showTaskModal({title:title,priority:'medium',...context});
}

function convertDecisionToTask(decId){
const dec=DB.get('decisions',decId);
if(!dec||!dec.decided)return;
autoCreateTask('Implementar: '+dec.title,{});
UI.toast('Tarea creada desde decisiÃ³n');
}

function convertOppToProject(oppId){
const opp=DB.get('opportunities',oppId);
if(!opp)return;
showProjModal({title:opp.title,desc:opp.desc,status:'planning',progress:0});
}

// ============ USER MODALS ============
function showUserModal(u=null){const ed=u!==null;const isCurrentUser=u?.id===DB.data.currentUser;UI.modal(ed?'Editar':'AÃ±adir',`<form id="userForm"><div class="form-group"><label class="form-label">Nombre *</label><input class="form-input" name="name" value="${u?.name||''}" required></div><div class="form-group"><label class="form-label">Cargo</label><input class="form-input" name="role" value="${u?.role||''}"></div><input type="hidden" name="id" value="${u?.id||''}"></form>`,`${ed&&!isCurrentUser?`<button class="btn btn-danger" onclick="delUser('${u.id}')">Eliminar</button>`:''}<button class="btn btn-secondary" onclick="UI.closeModal()">Cancelar</button><button class="btn btn-primary" onclick="saveUser()">Guardar</button>`)}
function saveUser(){const f=document.getElementById('userForm');const d=Object.fromEntries(new FormData(f));if(!d.name?.trim())return UI.toast('Nombre requerido','error');if(d.id){d.initials=d.name[0].toUpperCase();DB.update('users',d.id,d);UI.toast('Actualizado')}else{delete d.id;d.initials=d.name[0].toUpperCase();d.color='linear-gradient(135deg,#8b5cf6,#ec4899)';DB.add('users',d);UI.toast('AÃ±adido')}UI.closeModal();render()}
function editUser(id){showUserModal(DB.get('users',id))}
function delUser(id){UI.confirm('Â¿Eliminar miembro? Sus tareas quedarÃ¡n sin asignar.',`function(){DB.data.tasks.forEach(t=>{if(t.assignee==='${id}')t.assignee=null});DB.del('users','${id}');UI.toast('Eliminado');UI.closeModal();render()}`)}

function saveProfile(e){e.preventDefault();const d=Object.fromEntries(new FormData(e.target));d.initials=d.name[0].toUpperCase();DB.update('users',DB.data.currentUser,d);UI.toast('Guardado');render()}
function saveCo(e){e.preventDefault();const d=Object.fromEntries(new FormData(e.target));DB.data.company=d;DB.save();UI.toast('Guardado');document.querySelector('.brand').innerHTML=d.name+`<span>Command Center</span>`;document.querySelector('.logo').textContent=d.logo}
function confirmReset(){UI.confirm('Â¿Resetear TODO?',`function(){DB.reset();location.reload()}`)}

function toggleMenu(){document.getElementById('sidebar').classList.toggle('open');document.getElementById('overlay').classList.toggle('active')}
function closeMenu(){document.getElementById('sidebar').classList.remove('open');document.getElementById('overlay').classList.remove('active')}
function navMobile(p){closeMenu();nav(p)}

function toggleDashDropdown(e){if(e)e.stopPropagation();document.getElementById('dashDropdown').classList.toggle('open');var m=document.getElementById('dashDropdownMobile');if(m)m.classList.remove('open')}
function toggleDashDropdownMobile(e){if(e)e.stopPropagation();document.getElementById('dashDropdownMobile').classList.toggle('open');document.getElementById('dashDropdown').classList.remove('open')}
function closeDashDropdown(){document.getElementById('dashDropdown').classList.remove('open');var m=document.getElementById('dashDropdownMobile');if(m)m.classList.remove('open')}
function selectDash(id){
currentDash=id;
const d=DASHBOARDS.find(x=>x.id===id);
document.getElementById('currentDashIcon').textContent=d.icon;
document.getElementById('currentDashName').textContent=d.name;
const iconM=document.getElementById('currentDashIconMobile');
const nameM=document.getElementById('currentDashNameMobile');
if(iconM)iconM.textContent=d.icon;
if(nameM)nameM.textContent=d.name.split(' ')[0];
document.querySelectorAll('.dash-option').forEach(o=>o.classList.toggle('active',o.dataset.dash===id));
closeDashDropdown();
if(page==='dashboard')render();
}
document.addEventListener('click',e=>{if(!e.target.closest('.dash-selector'))closeDashDropdown()});
function init(){DB.init();const me=DB.me();const s=DB.stats();document.getElementById('app').innerHTML=`<div class="app">
<div class="overlay" id="overlay" onclick="closeMenu()"></div>
<div class="mobile-header visible">
<button class="menu-btn" onclick="toggleMenu()">â˜°</button>
<div class="dash-selector" style="flex:1">
<button class="dash-btn" onclick="toggleDashDropdownMobile(event)" style="width:100%;justify-content:center"><span id="currentDashIconMobile">ğŸ‘‘</span><span id="currentDashNameMobile">CEO</span><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:14px;height:14px"><path d="M6 9l6 6 6-6"/></svg></button>
<div class="dash-dropdown" id="dashDropdownMobile"></div>
</div>
<button class="btn btn-primary btn-sm" onclick="showTaskModal()">+</button>
</div>
<aside class="sidebar" id="sidebar">
<div class="sidebar-header"><div class="logo">${DB.data.company.logo}</div><div class="brand">${DB.data.company.name}<span>Command Center</span></div></div>
<nav class="nav">
<div class="nav-section"><div class="nav-label">Estrategia</div>
<div class="nav-item active" data-page="dashboard" onclick="navMobile('dashboard')"><span>ğŸ“Š</span>Dashboard</div>
<div class="nav-item" data-page="inbox" onclick="navMobile('inbox')"><span>ğŸ“¥</span>Inbox<span class="nav-badge" id="inboxBadge" style="background:var(--accent)">${s.inbox}</span></div>
<div class="nav-item" data-page="opportunities" onclick="navMobile('opportunities')"><span>ğŸ’¡</span>Oportunidades<span class="nav-badge" id="oppBadge" style="background:var(--yellow)">${s.opps}</span></div>
<div class="nav-item" data-page="decisions" onclick="navMobile('decisions')"><span>âš¡</span>Decisiones<span class="nav-badge" id="decBadge" style="background:var(--orange)">${s.decisions}</span></div>
<div class="nav-item" data-page="projects" onclick="navMobile('projects')"><span>ğŸ¯</span>Proyectos</div>
<div class="nav-item" data-page="objectives" onclick="navMobile('objectives')"><span>ğŸ“ˆ</span>Objetivos</div></div>
<div class="nav-section"><div class="nav-label">Comercial</div>
<div class="nav-item" data-page="comercial" onclick="navMobile('comercial')"><span>ğŸ’¼</span>Pipeline<span class="nav-badge" id="leadsBadge" style="background:var(--blue)">${s.activeLeads}</span></div>
<div class="nav-item" data-page="clients" onclick="navMobile('clients')"><span>ğŸ‘¥</span>Clientes<span class="nav-badge" id="clientsBadge" style="background:var(--cyan)">${s.clientsReview}</span></div>
<div class="nav-item" data-page="referrers" onclick="navMobile('referrers')"><span>ğŸ¤</span>Referidores</div></div>
<div class="nav-section"><div class="nav-label">Operativo</div>
<div class="nav-item" data-page="tasks" onclick="navMobile('tasks')"><span>âœ…</span>Tareas<span class="nav-badge" id="tasksBadge">${s.tasks}</span></div>
<div class="nav-item" data-page="team" onclick="navMobile('team')"><span>ğŸ§‘â€ğŸ¤â€ğŸ§‘</span>Equipo</div></div>
<div class="nav-section"><div class="nav-label">Paid Media</div>
<div class="nav-item" data-page="sowper" onclick="navMobile('sowper')"><span>ğŸŸ¢</span>Sowper</div></div>
<div class="nav-section"><div class="nav-label">Sistema</div>
<div class="nav-item" data-page="settings" onclick="navMobile('settings')"><span>âš™ï¸</span>Config</div></div>
</nav>
</aside>
<main class="main"><header class="header">
<div class="dash-selector">
<button class="dash-btn" onclick="toggleDashDropdown(event)"><span id="currentDashIcon">ğŸ‘‘</span><span id="currentDashName">CEO Overview</span><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg></button>
<div class="dash-dropdown" id="dashDropdown"></div>
</div>
<h2 class="page-title" id="pageTitle" style="margin-left:16px">Dashboard</h2>
</header><div class="content" id="pageContent"></div></main>
</div><div id="modals"></div><div class="toast-box" id="toasts"></div>`;
document.getElementById('dashDropdown').innerHTML=DASHBOARDS.map(d=>'<div class="dash-option '+(d.id==='ceo'?'active':'')+'" data-dash="'+d.id+'" onclick="selectDash(\''+d.id+'\')"><span>'+d.icon+'</span><div><div style="font-weight:600">'+d.name+'</div><div style="font-size:11px;opacity:.7">'+d.desc+'</div></div></div>').join('');
document.getElementById('dashDropdownMobile').innerHTML=DASHBOARDS.map(d=>'<div class="dash-option '+(d.id==='ceo'?'active':'')+'" data-dash="'+d.id+'" onclick="selectDash(\''+d.id+'\')"><span>'+d.icon+'</span><div><div style="font-weight:600">'+d.name+'</div><div style="font-size:11px;opacity:.7">'+d.desc+'</div></div></div>').join('');
render()}
init();
</script>
</body>
</html>
